<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --gold: #d4af37;
  --gold-light: #ffd700;
  --gold-dim: rgba(212,175,55,0.15);
  --dark: #060d1a;
  --dark2: #0d1b2a;
  --dark3: #112240;
  --card: rgba(17,34,64,0.8);
  --border: rgba(212,175,55,0.2);
  --text: #e2e8f0;
  --muted: rgba(255,255,255,0.45);
  --green: #10b981;
  --red: #ef4444;
  --amber: #f59e0b;
  --radius: 16px;

  /* light mode overrides (inactive by default) */
  --bg-body: #060d1a;
  --bg-sidebar: rgba(13,27,42,0.98);
  --bg-card: rgba(17,34,64,0.8);
  --text-main: #e2e8f0;
  --text-muted: rgba(255,255,255,0.45);
  --border-color: rgba(212,175,55,0.2);
  --input-bg: rgba(255,255,255,0.06);
  --input-text: #e2e8f0;
  --mesh1: rgba(212,175,55,0.06);
  --mesh2: rgba(16,185,129,0.04);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIGHT MODE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body.light-mode {
  --dark: #f0f4f8;
  --dark2: #e2e8f0;
  --dark3: #d1dce8;
  --card: rgba(255,255,255,0.92);
  --border: rgba(180,145,20,0.3);
  --text: #1a2744;
  --muted: rgba(30,50,90,0.5);
  --gold-dim: rgba(212,175,55,0.12);
  --bg-body: #eef2f8;
  --bg-sidebar: rgba(250,252,255,0.98);
  --bg-card: rgba(255,255,255,0.92);
  --text-main: #1a2744;
  --text-muted: rgba(30,50,90,0.5);
  --border-color: rgba(180,145,20,0.25);
  --input-bg: rgba(0,0,0,0.04);
  --input-text: #1a2744;
  --mesh1: rgba(212,175,55,0.04);
  --mesh2: rgba(16,185,129,0.02);
}

body.light-mode body::before {
  background:
    radial-gradient(ellipse 80% 50% at 20% 10%, var(--mesh1) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, var(--mesh2) 0%, transparent 60%);
}

body.light-mode .sidebar {
  background: linear-gradient(180deg, rgba(250,252,255,0.99) 0%, rgba(240,244,250,0.99) 100%);
  border-left-color: var(--border);
  box-shadow: -4px 0 20px rgba(0,0,0,0.08);
}
body.light-mode .nav-item { color: rgba(30,50,90,0.6); }
body.light-mode .nav-item:hover { background: rgba(212,175,55,0.1); color: #1a2744; }
body.light-mode .nav-item.active { color: #8b6914; background: rgba(212,175,55,0.15); }
body.light-mode .card {
  background: rgba(255,255,255,0.92);
  border-color: rgba(180,145,20,0.2);
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
body.light-mode .card-header h3 { color: #1a2744; }
body.light-mode .stat-card {
  background: rgba(255,255,255,0.9);
  border-color: rgba(180,145,20,0.2);
  box-shadow: 0 4px 15px rgba(0,0,0,0.07);
}
body.light-mode .form-input,
body.light-mode .form-select,
body.light-mode .form-textarea {
  background: rgba(0,0,0,0.04);
  border-color: rgba(180,145,20,0.25);
  color: #1a2744;
}
body.light-mode .form-select option { background: #f5f7fa; color: #1a2744; }
body.light-mode .form-input::placeholder { color: rgba(30,50,90,0.4); }
body.light-mode .form-input:focus,
body.light-mode .form-select:focus { background: rgba(212,175,55,0.05); border-color: var(--gold); }
body.light-mode .plate-input { background: rgba(0,0,0,0.04); border-color: rgba(180,145,20,0.25); }
body.light-mode .company-trigger { background: rgba(0,0,0,0.04); border-color: rgba(180,145,20,0.25); color: #1a2744; }
body.light-mode .company-dropdown { background: #f8fafc; border-color: var(--gold); }
body.light-mode .company-search-input { background: rgba(0,0,0,0.04); color: #1a2744; }
body.light-mode .company-option { color: #1a2744; }
body.light-mode .v-card { background: rgba(255,255,255,0.92); border-color: rgba(180,145,20,0.2); }
body.light-mode .v-card-header { border-bottom-color: rgba(180,145,20,0.15); }
body.light-mode .v-detail strong { color: #8b6914; }
body.light-mode .v-detail { color: #1a2744; border-color: rgba(0,0,0,0.05); }
body.light-mode .filter-select, body.light-mode .filter-input {
  background: rgba(0,0,0,0.04); border-color: rgba(180,145,20,0.25); color: #1a2744;
}
body.light-mode .filter-select option { background: #f5f7fa; }
body.light-mode .report-table th { background: rgba(212,175,55,0.15); }
body.light-mode .report-table td { color: #1a2744; border-color: rgba(0,0,0,0.06); }
body.light-mode .report-table tr:nth-child(even) td { background: rgba(0,0,0,0.02); }
body.light-mode .top-list li { border-color: rgba(0,0,0,0.06); }
body.light-mode .top-name { color: #1a2744; }
body.light-mode .map-btn { background: rgba(212,175,55,0.12); border-color: rgba(180,145,20,0.25); }
body.light-mode .upload-btn { background: rgba(212,175,55,0.1); border-color: rgba(180,145,20,0.3); }
body.light-mode .mobile-header { background: rgba(248,250,252,0.98); border-bottom-color: rgba(180,145,20,0.2); }
body.light-mode .btn-logout { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.2); }
body.light-mode .wa-settings { background: rgba(37,211,102,0.06); border-color: rgba(37,211,102,0.2); }
body.light-mode .login-card { background: rgba(255,255,255,0.95); border-color: rgba(180,145,20,0.25); }
body.light-mode .form-label { color: #8b6914; }
body.light-mode .page-subtitle { color: rgba(30,50,90,0.5); }
body.light-mode .stat-label { color: rgba(30,50,90,0.55); }
body.light-mode .dl-btn { background: rgba(0,0,0,0.04); border-color: rgba(180,145,20,0.25); color: #8b6914; }
body.light-mode .mobile-bottom-nav { background: rgba(250,252,255,0.98); border-top-color: rgba(180,145,20,0.2); }
body.light-mode .bottom-nav-item { color: rgba(30,50,90,0.5); }
body.light-mode .bottom-nav-item.active { color: #8b6914; }

/* â•â•â• Theme Toggle Button â•â•â• */
.theme-toggle-btn {
  width: 100%;
  padding: 10px 14px;
  border-radius: 10px;
  background: var(--gold-dim);
  border: 1px solid var(--border);
  color: var(--gold);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Tajawal', sans-serif;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  transition: all 0.2s;
}
.theme-toggle-btn:hover { background: rgba(212,175,55,0.25); }
body.light-mode .theme-toggle-btn { background: rgba(0,0,0,0.04); border-color: rgba(180,145,20,0.25); color: #8b6914; }

/* â•â•â• Theme Toggle Pill (floating) â•â•â• */
.theme-pill {
  position: fixed; top: 16px; left: 16px; z-index: 9999;
  display: flex; align-items: center; gap: 6px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 30px;
  padding: 6px 14px;
  cursor: pointer;
  font-family: 'Tajawal', sans-serif;
  font-size: 13px; font-weight: 700;
  color: var(--gold);
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  transition: all 0.3s;
  backdrop-filter: blur(20px);
}
.theme-pill:hover { transform: scale(1.05); }
body.light-mode .theme-pill { background: rgba(255,255,255,0.95); color: #8b6914; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Tajawal', sans-serif;
  background: var(--dark);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 0.3s, color 0.3s;
}

/* â”€â”€ Background mesh â”€â”€ */
body::before {
  content:'';
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 80% 50% at 20% 10%, rgba(212,175,55,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(16,185,129,0.04) 0%, transparent 60%),
    radial-gradient(ellipse 100% 80% at 50% 50%, rgba(6,13,26,0) 0%, var(--dark) 100%);
}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar {
  position: fixed; top:0; right:0; bottom:0;
  width: 260px; z-index:100;
  background: linear-gradient(180deg, rgba(13,27,42,0.98) 0%, rgba(6,13,26,0.98) 100%);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  backdrop-filter: blur(20px);
  transition: transform 0.3s ease;
}
.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo .logo-icon {
  width:48px; height:48px; border-radius:12px;
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  display:flex; align-items:center; justify-content:center;
  font-size:22px; margin-bottom:10px;
}
.sidebar-logo h2 {
  font-size:15px; font-weight:900; color:var(--gold-light);
  line-height:1.3;
}
.sidebar-logo p { font-size:11px; color:var(--muted); margin-top:3px; }

.sidebar-user {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.user-avatar {
  width:38px; height:38px; border-radius:10px;
  background: var(--gold-dim); border:1px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
}
.user-info { flex:1; min-width:0; }
.user-name { font-size:13px; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.user-role { font-size:11px; color:var(--gold); }

.sidebar-nav { flex:1; padding:16px 12px; overflow-y:auto; }
.nav-item {
  display:flex; align-items:center; gap:12px;
  padding:12px 14px; border-radius:12px; cursor:pointer;
  color:var(--muted); font-size:14px; font-weight:500;
  transition:all 0.2s; margin-bottom:4px;
  border: 1px solid transparent;
}
.nav-item:hover { background:var(--gold-dim); color:var(--text); }
.nav-item.active {
  background: linear-gradient(135deg, rgba(212,175,55,0.2), rgba(212,175,55,0.05));
  color:var(--gold-light); border-color:var(--border); font-weight:700;
}
.nav-item .nav-icon { font-size:18px; width:24px; text-align:center; }
.nav-badge {
  margin-right:auto; background:var(--gold); color:var(--dark);
  border-radius:20px; padding:2px 8px; font-size:11px; font-weight:900;
}

.sidebar-footer {
  padding:16px 12px;
  border-top: 1px solid var(--border);
}
.btn-logout {
  width:100%; padding:11px; border-radius:12px;
  background: rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3);
  color:#fca5a5; font-size:13px; font-weight:700; cursor:pointer;
  font-family:'Tajawal',sans-serif; transition:all 0.2s;
}
.btn-logout:hover { background:rgba(239,68,68,0.2); }

/* â”€â”€ Main content â”€â”€ */
.main {
  margin-left: 0;
  margin-right: 260px;
  min-height: 100vh;
  padding: 28px;
  position: relative; z-index:1;
}

/* â”€â”€ Page header â”€â”€ */
.page-header {
  margin-bottom:28px;
  display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:16px;
}
.page-title { font-size:24px; font-weight:900; color:var(--gold-light); }
.page-subtitle { font-size:13px; color:var(--muted); margin-top:3px; }

/* â”€â”€ Cards â”€â”€ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  backdrop-filter: blur(20px);
  overflow: hidden;
}
.card-header {
  padding:20px 24px 16px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.card-header h3 { font-size:16px; font-weight:700; color:var(--text); }
.card-body { padding:24px; }

/* â”€â”€ Stat cards â”€â”€ */
.stats-row {
  display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:16px;
  margin-bottom:24px;
}
.stat-card {
  background: var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  position:relative; overflow:hidden;
  transition: transform 0.2s, box-shadow 0.2s;
}
.stat-card:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(0,0,0,0.3); }
.stat-card::before {
  content:''; position:absolute; inset:0;
  background: linear-gradient(135deg, var(--accent-color,rgba(212,175,55,0.08)) 0%, transparent 60%);
}
.stat-card.gold  { --accent-color: rgba(212,175,55,0.12); }
.stat-card.green { --accent-color: rgba(16,185,129,0.12); }
.stat-card.red   { --accent-color: rgba(239,68,68,0.10); }
.stat-card.amber { --accent-color: rgba(245,158,11,0.10); }
.stat-card.blue  { --accent-color: rgba(59,130,246,0.10); }

.stat-icon {
  width:42px; height:42px; border-radius:10px;
  display:flex; align-items:center; justify-content:center; font-size:20px;
  margin-bottom:12px;
}
.stat-card.gold  .stat-icon { background:rgba(212,175,55,0.15); }
.stat-card.green .stat-icon { background:rgba(16,185,129,0.15); }
.stat-card.red   .stat-icon { background:rgba(239,68,68,0.12); }
.stat-card.amber .stat-icon { background:rgba(245,158,11,0.12); }
.stat-card.blue  .stat-icon { background:rgba(59,130,246,0.12); }

.stat-value {
  font-size:34px; font-weight:900;
  line-height:1; margin-bottom:4px;
}
.stat-card.gold  .stat-value { color:var(--gold-light); }
.stat-card.green .stat-value { color:#34d399; }
.stat-card.red   .stat-value { color:#f87171; }
.stat-card.amber .stat-value { color:#fbbf24; }
.stat-card.blue  .stat-value { color:#60a5fa; }
.stat-label { font-size:12px; color:var(--muted); font-weight:500; }

/* â”€â”€ Charts grid â”€â”€ */
.charts-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;
}
.chart-container { position:relative; height:240px; }

/* â”€â”€ Top lists â”€â”€ */
.top-list { list-style:none; }
.top-list li {
  display:flex; align-items:center; gap:12px;
  padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.05);
}
.top-list li:last-child { border-bottom:none; }
.top-rank {
  width:26px; height:26px; border-radius:8px; font-size:12px; font-weight:900;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
  background: var(--gold-dim); color:var(--gold);
}
.top-name { flex:1; font-size:13px; color:var(--text); font-weight:500; }
.top-count { font-size:13px; font-weight:700; color:var(--gold); }
.top-bar-wrap { width:80px; height:4px; background:rgba(255,255,255,0.1); border-radius:2px; }
.top-bar { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--gold),var(--gold-light)); }

/* â”€â”€ Forms â”€â”€ */
.form-section { margin-bottom:20px; }
.form-label {
  display:block; font-size:13px; font-weight:700; color:var(--gold);
  margin-bottom:8px;
}
.form-label .req { color:#ef4444; margin-right:3px; }
.form-input, .form-select, .form-textarea {
  width:100%; padding:13px 16px;
  background: rgba(255,255,255,0.06);
  border:1px solid var(--border); border-radius:10px;
  color:var(--text); font-size:14px; font-family:'Tajawal',sans-serif; font-weight:500;
  transition: border-color 0.2s, background 0.2s;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline:none; border-color:var(--gold);
  background: rgba(212,175,55,0.06);
  box-shadow: 0 0 0 3px rgba(212,175,55,0.12);
}
.form-input::placeholder { color:var(--muted); }
.form-select option { background:#1a2744; }
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }

/* â”€â”€ Plate inputs â”€â”€ */
.plate-wrap {
  display:flex; align-items:flex-start; gap:12px;
}
.plate-box { flex:1; }
.plate-input {
  width:100%; padding:13px 12px;
  background: rgba(255,255,255,0.06);
  border:1px solid var(--border); border-radius:10px;
  color:var(--gold-light); font-size:22px; font-weight:900;
  text-align:center; letter-spacing:6px; font-family:monospace;
  transition: border-color 0.2s;
}
.plate-input:focus { outline:none; border-color:var(--gold); }
.plate-hint { text-align:center; font-size:11px; color:var(--muted); margin-top:5px; }
.plate-sep { padding-top:12px; color:var(--gold); font-size:24px; font-weight:900; }
.plate-preview {
  display:none; margin-top:12px; text-align:center;
  background:var(--gold-dim); border:1px solid var(--border);
  border-radius:10px; padding:10px; font-size:20px;
  font-weight:900; color:var(--gold-light); letter-spacing:8px; font-family:monospace;
}

/* â”€â”€ Company dropdown â”€â”€ */
.company-trigger {
  width:100%; padding:13px 16px;
  background: rgba(255,255,255,0.06);
  border:1px solid var(--border); border-radius:10px;
  color:var(--text); font-size:14px; font-family:'Tajawal',sans-serif; font-weight:500;
  display:flex; justify-content:space-between; align-items:center;
  cursor:pointer; transition: border-color 0.2s;
}
.company-trigger:hover { border-color:rgba(212,175,55,0.5); }
.company-trigger.open { border-color:var(--gold); }
.company-dropdown {
  display:none; position:absolute;
  left:0; right:0; top:calc(100% + 4px);
  background:#0d1b2a; border:1px solid var(--gold);
  border-radius:12px; padding:12px; z-index:999;
  max-height:280px; overflow-y:auto;
  box-shadow:0 16px 40px rgba(0,0,0,0.6);
}
.company-search-input {
  width:100%; padding:10px 14px;
  background:rgba(255,255,255,0.08); border:1px solid var(--border); border-radius:8px;
  color:var(--text); font-size:13px; font-family:'Tajawal',sans-serif;
  margin-bottom:10px;
}
.company-search-input:focus { outline:none; border-color:var(--gold); }
.company-option {
  padding:9px 12px; border-radius:8px; cursor:pointer;
  color:var(--text); font-size:13px; font-weight:500; transition:background 0.15s;
}
.company-option:hover, .company-option.selected { background:var(--gold-dim); color:var(--gold-light); }
.company-wrap { position:relative; }

/* â”€â”€ Map â”€â”€ */
.map-actions { display:flex; gap:10px; margin-bottom:12px; }
.map-btn {
  flex:1; padding:11px; border-radius:10px;
  background:var(--gold-dim); border:1px solid var(--border);
  color:var(--gold); font-size:13px; font-weight:700;
  cursor:pointer; font-family:'Tajawal',sans-serif; transition:all 0.2s;
}
.map-btn:hover { background:rgba(212,175,55,0.25); }
#map { height:320px; border-radius:12px; border:1px solid var(--border); display:none; }
.location-result {
  margin-top:10px; padding:12px 16px;
  background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2);
  border-radius:10px; display:none;
}
.location-result a { color:#34d399; text-decoration:underline; font-size:13px; }

/* â”€â”€ Image upload â”€â”€ */
.upload-btn {
  width:100%; padding:13px; border-radius:10px;
  background:var(--gold-dim); border:2px dashed var(--border);
  color:var(--gold); font-size:13px; font-weight:700;
  cursor:pointer; font-family:'Tajawal',sans-serif; transition:all 0.2s; text-align:center;
}
.upload-btn:hover { border-color:var(--gold); background:rgba(212,175,55,0.2); }
.img-preview-grid { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
.img-preview-item {
  position:relative; width:90px; height:90px;
  border-radius:10px; overflow:hidden;
  border:1px solid var(--border);
}
.img-preview-item img { width:100%; height:100%; object-fit:cover; }
.img-remove {
  position: absolute; top: 4px; right: 4px;
  background: rgba(239,68,68,0.85); color: white;
  border: none; border-radius: 50%; width: 22px; height: 22px;
  font-size: 14px; font-weight: 900; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  line-height: 1;
}

/* â”€â”€ Buttons â”€â”€ */
.btn-primary {
  width:100%; padding:15px; border-radius:12px;
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  border:none; color:var(--dark); font-size:16px; font-weight:900;
  cursor:pointer; font-family:'Tajawal',sans-serif;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 20px rgba(212,175,55,0.3);
}
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 8px 30px rgba(212,175,55,0.4); }
.btn-primary:active { transform:translateY(0); }
.btn-sm {
  padding:7px 14px; border-radius:8px; font-size:12px; font-weight:700;
  cursor:pointer; font-family:'Tajawal',sans-serif; transition:all 0.2s; border:none;
}
.btn-approve { background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3); color:#34d399; }
.btn-approve:hover { background:rgba(16,185,129,0.25); }
.btn-reject  { background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.3); color:#f87171; }
.btn-reject:hover  { background:rgba(239,68,68,0.22); }
.btn-pdf { background:var(--gold-dim); border:1px solid var(--border); color:var(--gold); }
.btn-pdf:hover { background:rgba(212,175,55,0.25); }

/* â”€â”€ Violation cards â”€â”€ */
.v-card {
  background:rgba(255,255,255,0.03); border:1px solid var(--border);
  border-radius:12px; padding:18px; margin-bottom:12px;
  transition:border-color 0.2s;
}
.v-card:hover { border-color:rgba(212,175,55,0.4); }
.v-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
.v-ref { font-size:16px; font-weight:900; color:var(--gold-light); font-family:monospace; }
.v-status {
  padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700;
}
.v-status.pending { background:rgba(245,158,11,0.15); color:#fbbf24; border:1px solid rgba(245,158,11,0.3); }
.v-status.approved { background:rgba(16,185,129,0.15); color:#34d399; border:1px solid rgba(16,185,129,0.3); }
.v-status.rejected { background:rgba(239,68,68,0.12); color:#f87171; border:1px solid rgba(239,68,68,0.3); }
.v-details { display:grid; grid-template-columns:1fr 1fr; gap:6px 16px; margin-bottom:12px; }
.v-detail { font-size:12px; color:var(--muted); }
.v-detail strong { color:var(--text); display:block; font-size:13px; margin-bottom:1px; }
.v-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.05); }
.v-notes-input {
  width:100%; padding:10px 14px; border-radius:8px;
  background:rgba(255,255,255,0.05); border:1px solid var(--border);
  color:var(--text); font-size:13px; font-family:'Tajawal',sans-serif;
  margin-bottom:8px;
}
.v-notes-input:focus { outline:none; border-color:var(--gold); }

/* â”€â”€ Search â”€â”€ */
.search-wrap { position:relative; margin-bottom:20px; }
.search-icon { position:absolute; top:50%; transform:translateY(-50%); right:16px; color:var(--muted); }
.search-input {
  width:100%; padding:12px 44px 12px 16px;
  background:rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:10px;
  color:var(--text); font-size:14px; font-family:'Tajawal',sans-serif;
}
.search-input:focus { outline:none; border-color:var(--gold); }
.search-input::placeholder { color:var(--muted); }

/* â”€â”€ Login page â”€â”€ */
#loginPage {
  min-height:100vh; display:flex; align-items:center; justify-content:center;
  padding:20px;
  background: linear-gradient(135deg, var(--dark) 0%, var(--dark2) 50%, var(--dark3) 100%);
}
.login-card {
  width:100%; max-width:440px;
  background:rgba(13,27,42,0.9); border:1px solid var(--border);
  border-radius:24px; padding:40px; backdrop-filter:blur(20px);
  box-shadow: 0 40px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(212,175,55,0.05);
}
.login-logo {
  text-align:center; margin-bottom:32px;
}
.login-logo .icon {
  width:72px; height:72px; border-radius:20px; margin:0 auto 16px;
  background:linear-gradient(135deg,var(--gold),var(--gold-light));
  display:flex; align-items:center; justify-content:center; font-size:34px;
}
.login-logo h1 { font-size:22px; font-weight:900; color:var(--gold-light); }
.login-logo p { font-size:13px; color:var(--muted); margin-top:4px; }
.login-tabs { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-bottom:24px; }
.login-tab {
  flex:1; padding:10px; border-radius:10px; cursor:pointer; text-align:center;
  font-size:13px; font-weight:700; transition:all 0.2s;
  background:rgba(255,255,255,0.04); border:1px solid var(--border); color:var(--muted);
  font-family:'Tajawal',sans-serif;
}
.login-tab.active {
  background:var(--gold-dim); border-color:var(--gold); color:var(--gold-light);
}
.login-error {
  background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.3);
  color:#fca5a5; padding:12px 16px; border-radius:10px; font-size:13px;
  margin-bottom:16px; display:none;
}
.login-success-msg {
  text-align:center; padding:20px;
  background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2);
  border-radius:12px; margin-bottom:20px; display:none;
}
.success-ref { font-size:26px; font-weight:900; color:var(--gold-light); font-family:monospace; letter-spacing:2px; margin:10px 0; }

/* â”€â”€ Toast â”€â”€ */
.toast {
  position:fixed; top:24px; left:24px; z-index:9999;
  background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3);
  color:#34d399; padding:14px 20px; border-radius:12px;
  font-size:13px; font-weight:700; display:none;
  backdrop-filter:blur(10px);
  animation: slideIn 0.3s ease;
}
@keyframes slideIn {
  from { opacity:0; transform:translateX(-20px); }
  to   { opacity:1; transform:translateX(0); }
}

/* â”€â”€ Tabs (mobile nav) â”€â”€ */
.mobile-header {
  display:none; align-items:center; justify-content:space-between;
  padding:16px 20px; background:rgba(13,27,42,0.95);
  border-bottom:1px solid var(--border); position:sticky; top:0; z-index:50;
}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(212,175,55,0.3); border-radius:3px; }

/* â”€â”€ Download btn â”€â”€ */
.dl-btn {
  display:none !important;
  display:none; align-items:center; gap:8px;
  padding:10px 18px; border-radius:10px;
  background:var(--gold-dim); border:1px solid var(--border);
  color:var(--gold); font-size:13px; font-weight:700; cursor:pointer;
  font-family:'Tajawal',sans-serif; transition:all 0.2s;
}
.dl-btn:hover { background:rgba(212,175,55,0.25); }
.dl-badge { background:var(--gold); color:var(--dark); border-radius:20px; padding:2px 7px; font-size:11px; font-weight:900; }

/* â”€â”€ Responsive â”€â”€ */
@media (max-width:768px) {
  /* Sidebar */
  .sidebar {
    transform: translateX(110%);
    width: 280px;
    z-index: 200;
    transition: transform 0.3s cubic-bezier(.4,0,.2,1);
  }
  .sidebar.open { transform: translateX(0); }

  /* Overlay behind sidebar */
  .sidebar-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 199;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(2px);
  }
  .sidebar-overlay.show { display: block; }

  /* Main */
  .main { margin-right: 0; padding: 12px; padding-bottom: 80px; }
  .mobile-header { display: flex; }

  /* Charts & grids */
  .charts-grid { grid-template-columns: 1fr; }
  .form-grid { grid-template-columns: 1fr; }
  .v-details { grid-template-columns: 1fr; }
  .stats-row { grid-template-columns: 1fr 1fr; }

  /* Violation card actions â€” stack on mobile */
  .v-actions {
    flex-direction: column;
    gap: 10px;
  }
  .v-notes-input {
    width: 100%;
    font-size: 14px;
    padding: 12px;
  }
  .v-actions .btn-sm {
    width: 100%;
    padding: 13px;
    font-size: 14px;
    border-radius: 10px;
    text-align: center;
  }
  .btn-approve, .btn-reject, .btn-pdf {
    display: block;
    width: 100% !important;
  }

  /* Page header */
  .page-header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .page-title { font-size: 20px; }

  /* Login */
  .login-card { padding: 28px 20px; border-radius: 18px; }
  .login-logo h1 { font-size: 20px; }

  /* Bottom nav bar */
  .mobile-bottom-nav {
    display: flex !important;
  }

  /* Report period buttons */
  .report-period-btns { flex-wrap: wrap; }
  .btn-period { flex: 1; min-width: 80px; padding: 10px 8px; font-size: 12px; }

  /* Filter bar */
  .filter-bar { flex-direction: column; }
  .filter-group { min-width: 100%; }
}

/* Mobile header bar */
.mobile-header {
  display: none;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: rgba(13,27,42,0.98);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 50;
  backdrop-filter: blur(12px);
}
.mobile-header-title {
  font-size: 15px; font-weight: 900; color: var(--gold-light);
  display: flex; align-items: center; gap: 8px;
}
.hamburger-btn {
  width: 42px; height: 42px; border-radius: 10px;
  background: var(--gold-dim); border: 1px solid var(--border);
  color: var(--gold); font-size: 20px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.hamburger-btn:hover { background: rgba(212,175,55,0.25); }

/* Bottom nav bar for mobile */
.mobile-bottom-nav {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 150;
  background: rgba(13,27,42,0.98);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(16px);
  padding: 6px 0 env(safe-area-inset-bottom, 6px);
  justify-content: space-around;
  align-items: center;
}
.bottom-nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 6px 12px; border-radius: 10px; cursor: pointer;
  color: var(--muted); font-size: 10px; font-weight: 700;
  transition: all 0.2s; min-width: 48px; text-align: center;
  border: none; background: transparent;
}
.bottom-nav-item .bn-icon { font-size: 28px; line-height: 1; }
.bottom-nav-item { font-size: 11px; padding: 8px 10px; }
.bottom-nav-item.active { color: var(--gold-light); }
.bottom-nav-item.active .bn-icon {
  background: var(--gold-dim);
  border-radius: 10px; padding: 5px 7px;
}
.bottom-nav-badge {
  position: absolute; top: 2px; right: 2px;
  background: var(--red); color: white;
  border-radius: 10px; padding: 1px 5px; font-size: 9px; font-weight: 900;
}
.bottom-nav-wrap { position: relative; }
.hide { display:none !important; }

/* â”€â”€ Advanced Filter â”€â”€ */
.filter-bar {
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  padding:18px 20px; margin-bottom:20px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;
}
.filter-group { display:flex; flex-direction:column; gap:6px; min-width:130px; flex:1; }
.filter-label { font-size:11px; font-weight:700; color:var(--gold); }
.filter-select, .filter-input {
  padding:9px 12px; background:rgba(255,255,255,0.06); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-size:12px; font-family:'Tajawal',sans-serif;
}
.filter-select:focus, .filter-input:focus { outline:none; border-color:var(--gold); }
.filter-select option { background:#1a2744; }
.filter-actions { display:flex; gap:8px; align-items:flex-end; }
.btn-filter { padding:9px 16px; border-radius:8px; font-size:12px; font-weight:700;
  cursor:pointer; font-family:'Tajawal',sans-serif; transition:all 0.2s; border:none; }
.btn-filter-apply { background:linear-gradient(135deg,var(--gold),var(--gold-light)); color:var(--dark); }
.btn-filter-reset { background:rgba(255,255,255,0.07); border:1px solid var(--border) !important; color:var(--muted); border:none; }
.filter-result-count { font-size:12px; color:var(--muted); padding:4px 0; }

/* â”€â”€ WhatsApp notification â”€â”€ */
.wa-settings { background:rgba(37,211,102,0.08); border:1px solid rgba(37,211,102,0.25);
  border-radius:12px; padding:16px 20px; margin-bottom:16px; }
.wa-settings h4 { color:#25d366; font-size:14px; margin-bottom:12px; }
.wa-toggle { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.toggle-switch { position:relative; width:44px; height:24px; }
.toggle-switch input { opacity:0; width:0; height:0; }
.toggle-slider {
  position:absolute; cursor:pointer; inset:0; background:rgba(255,255,255,0.1);
  border-radius:24px; transition:.3s;
}
.toggle-slider:before {
  position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px;
  background:white; border-radius:50%; transition:.3s;
}
input:checked + .toggle-slider { background:#25d366; }
input:checked + .toggle-slider:before { transform:translateX(20px); }
.wa-number-row { display:flex; gap:8px; }
.wa-number-input { flex:1; }

/* â”€â”€ Reports Tab â”€â”€ */
.report-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px; }
.report-period-btns { display:flex; gap:8px; margin-bottom:20px; }
.btn-period {
  padding:10px 20px; border-radius:10px; font-size:13px; font-weight:700;
  cursor:pointer; font-family:'Tajawal',sans-serif; transition:all 0.2s;
  background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--muted);
}
.btn-period.active { background:var(--gold-dim); border-color:var(--gold); color:var(--gold-light); }
.report-stat { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; text-align:center; }
.report-stat-num { font-size:36px; font-weight:900; color:var(--gold-light); }
.report-stat-label { font-size:12px; color:var(--muted); margin-top:4px; }
.report-table { width:100%; border-collapse:collapse; font-size:13px; }
.report-table th { padding:10px 14px; background:rgba(212,175,55,0.12); color:var(--gold); text-align:right; border:1px solid rgba(212,175,55,0.2); }
.report-table td { padding:10px 14px; border:1px solid rgba(255,255,255,0.05); color:var(--text); }
.report-table tr:nth-child(even) td { background:rgba(255,255,255,0.02); }
.btn-dl-report {
  display:inline-flex; align-items:center; gap:8px; padding:11px 20px; border-radius:10px;
  background:var(--gold-dim); border:1px solid var(--border); color:var(--gold);
  font-size:13px; font-weight:700; cursor:pointer; font-family:'Tajawal',sans-serif; transition:all 0.2s;
}
.btn-dl-report:hover { background:rgba(212,175,55,0.25); }
/* â”€â”€ Repeat Offender Badges â”€â”€ */
.repeat-badge {
  display:inline-flex; align-items:center; gap:5px;
  padding:3px 10px; border-radius:20px; font-size:11px; font-weight:800;
  margin-left:6px;
}
.repeat-badge.plate { background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.4); color:#f87171; }
.repeat-badge.id    { background:rgba(245,158,11,0.15); border:1px solid rgba(245,158,11,0.4); color:#fbbf24; }
.repeat-badge.co    { background:rgba(168,85,247,0.15); border:1px solid rgba(168,85,247,0.4); color:#c084fc; }

.repeat-warning {
  margin: 8px 0;
  padding: 10px 14px;
  border-radius: 10px;
  background: rgba(239,68,68,0.08);
  border: 1px solid rgba(239,68,68,0.3);
  font-size: 12px;
  color: #fca5a5;
  display: flex; flex-direction:column; gap:4px;
}
.repeat-warning .rw-title { font-weight:900; font-size:13px; color:#f87171; margin-bottom:4px; }
.repeat-warning .rw-item  { color:#e2e8f0; }
.repeat-warning .rw-item span { color:#fbbf24; font-weight:700; }

.repeat-form-alert {
  padding:10px 14px; border-radius:10px; margin-top:8px;
  background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.35);
  color:#f87171; font-size:12px; font-weight:700; display:none;
}

/* Admin repeat table */
.repeat-count-badge {
  display:inline-block; background:rgba(239,68,68,0.2); border:1px solid rgba(239,68,68,0.5);
  color:#f87171; border-radius:20px; padding:2px 10px; font-size:12px; font-weight:900;
}
@media (max-width:768px) {
  .report-grid { grid-template-columns:1fr; }
  .filter-bar { flex-direction:column; }
}

/* â”€â”€ Light mode extra text fixes â”€â”€ */
body.light-mode { color: #1a2744; }
body.light-mode .page-title { color: #1a2744 !important; }
body.light-mode .page-subtitle { color: #4a6080 !important; }
body.light-mode .stat-value { color: #1a2744 !important; }
body.light-mode .stat-label { color: #4a6080 !important; }
body.light-mode .user-name { color: #1a2744 !important; }
body.light-mode .user-role { color: #4a6080 !important; }
body.light-mode .v-ref { color: #8b6914 !important; }
body.light-mode .form-label { color: #6b5010 !important; font-weight: 700; }
body.light-mode .card-header h3 { color: #1a2744 !important; }
body.light-mode h3, body.light-mode h4 { color: #1a2744 !important; }
body.light-mode strong { color: #6b5010 !important; }
body.light-mode .top-name { color: #1a2744 !important; }
body.light-mode .top-count { color: #8b6914 !important; }
body.light-mode .top-rank { color: #8b6914 !important; border-color: rgba(139,105,20,0.3) !important; }
body.light-mode .filter-input::placeholder { color: rgba(30,50,90,0.4) !important; }
body.light-mode .company-search-input::placeholder { color: rgba(30,50,90,0.4) !important; }
body.light-mode .report-table td { color: #1a2744 !important; }
body.light-mode .report-table th { color: #6b5010 !important; }
body.light-mode .dl-btn { color: #6b5010 !important; border-color: rgba(139,105,20,0.3) !important; background: rgba(212,175,55,0.1) !important; }
body.light-mode .btn-logout { color: #c0392b !important; }
body.light-mode .sidebar-logo h2 { color: #8b6914 !important; }
body.light-mode .sidebar-logo p { color: #4a6080 !important; }
body.light-mode .login-card h1 { color: #1a2744 !important; }
body.light-mode .login-card p { color: #4a6080 !important; }
body.light-mode .login-tab { color: #4a6080 !important; }
body.light-mode .login-tab.active { color: #6b5010 !important; background: rgba(212,175,55,0.15) !important; border-color: var(--gold) !important; }
body.light-mode .mobile-header-title { color: #8b6914 !important; }
body.light-mode .hamburger-btn { color: #8b6914 !important; }
body.light-mode .bottom-nav-item { color: rgba(30,50,90,0.55) !important; }
body.light-mode .bottom-nav-item.active { color: #8b6914 !important; }
body.light-mode .v-card-header { background: rgba(212,175,55,0.06) !important; }
body.light-mode .v-status.pending { background: rgba(245,158,11,0.15) !important; color: #b45309 !important; border-color: rgba(245,158,11,0.4) !important; }
body.light-mode .v-status.approved { background: rgba(16,185,129,0.12) !important; color: #065f46 !important; border-color: rgba(16,185,129,0.4) !important; }
body.light-mode .v-status.rejected { background: rgba(239,68,68,0.1) !important; color: #991b1b !important; border-color: rgba(239,68,68,0.3) !important; }
body.light-mode .repeat-badge.plate { background: rgba(239,68,68,0.12) !important; color: #991b1b !important; }
body.light-mode .repeat-badge.id { background: rgba(245,158,11,0.12) !important; color: #92400e !important; }
body.light-mode .repeat-warning { background: rgba(239,68,68,0.06) !important; border-color: rgba(239,68,68,0.25) !important; }
body.light-mode .repeat-warning .rw-title { color: #991b1b !important; }
body.light-mode .repeat-warning .rw-item { color: #1a2744 !important; }
body.light-mode .img-preview-grid img { border-color: rgba(180,145,20,0.3) !important; }
body.light-mode .upload-btn { color: #6b5010 !important; }
body.light-mode .plate-preview { background: rgba(212,175,55,0.12) !important; border-color: rgba(180,145,20,0.3) !important; color: #6b5010 !important; }
body.light-mode .plate-input { color: #1a2744 !important; }
body.light-mode .location-result { color: #1a2744 !important; }
body.light-mode .success-msg { background: rgba(16,185,129,0.1) !important; border-color: rgba(16,185,129,0.3) !important; color: #065f46 !important; }
body.light-mode .theme-pill { background: rgba(255,255,255,0.95) !important; color: #6b5010 !important; box-shadow: 0 4px 20px rgba(0,0,0,0.12) !important; }
body.light-mode .toast { color: #1a2744 !important; }

/* â”€â”€ Login tab 3 columns â”€â”€ */

</style>
</head>
<body>

<!-- â”€â”€â”€ THEME TOGGLE PILL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<button class="theme-pill" id="themePill" onclick="toggleTheme()" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ/Ø§Ù„Ù„ÙŠÙ„ÙŠ">
  <span id="themeIcon" style="font-size:18px;">â˜€ï¸</span>
  <span id="themeLabel">Ù†Ù‡Ø§Ø±ÙŠ</span>
</button>

<!-- â”€â”€â”€ LOGIN PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loginPage">
  <div class="login-card">
    <div class="login-logo">
      <div class="icon" style="font-size:52px;line-height:1;margin-bottom:10px;">âš ï¸</div>
      <h1>Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠØ©</h1>
      <p>Qiddiya Violations Management System</p>
    </div>
    <div class="login-tabs">
      <button class="login-tab active" onclick="switchLoginTab('employee')" id="empTab">ğŸ‘· Ù…ÙˆØ¸Ù</button>
      <button class="login-tab" onclick="switchLoginTab('supervisor')" id="supTab">ğŸ‘” Ù…Ø´Ø±Ù</button>
      <button class="login-tab" onclick="switchLoginTab('admin')" id="adminTab">ğŸ›¡ï¸ Ù…Ø±Ø§Ù‚Ø¨</button>
    </div>
    <div class="login-error" id="loginError"></div>
    <div class="form-section">
      <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
      <input class="form-input" type="text" id="employeeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" maxlength="20" autocomplete="username">
    </div>
    <div class="form-section">
      <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</label>
      <input class="form-input" type="password" id="userPassword" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ" maxlength="20">
    </div>
    <div class="form-section" id="supervisorCodeField" style="display:none;">
      <label class="form-label">ğŸ”‘ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø´Ø±Ù</label>
      <input class="form-input" type="password" id="supervisorCode" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù" autocomplete="off">
    </div>
    <button class="btn-primary" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="mainApp" class="hide">

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Sidebar overlay (mobile) -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon" style="font-size:32px;">âš ï¸</div>
      <h2>Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠØ©</h2>
      <p>Qiddiya Violations System</p>
    </div>
    <div class="sidebar-user">
      <div class="user-avatar">ğŸ‘¤</div>
      <div class="user-info">
        <div class="user-name" id="userName">â€”</div>
        <div class="user-role" id="userRole">Ù…ÙˆØ¸Ù</div>
      </div>
    </div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
    <div class="sidebar-footer">
      <button class="dl-btn" id="excelBtn" onclick="downloadExcelFile()">
        ğŸ“Š ØªØµØ¯ÙŠØ± Excel <span class="dl-badge" id="excelBadge">0</span>
      </button>
      <button class="btn-logout" onclick="logout()" style="margin-top:8px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </aside>

  <!-- Mobile header -->
  <div class="mobile-header" id="mobileHeader">
    <div class="mobile-header-title" style="font-size:17px;gap:10px;">âš ï¸ Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠØ©</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <button class="hamburger-btn" id="mobileNotifBtn" onclick="showTab('notifications');closeSidebar();" style="font-size:16px;position:relative;" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
        ğŸ””
        <span id="mobileNotifBadge" style="display:none;position:absolute;top:2px;right:2px;background:var(--red);color:white;border-radius:10px;padding:1px 5px;font-size:8px;font-weight:900;"></span>
      </button>
      <button class="hamburger-btn" onclick="logout()" style="font-size:16px;background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#f87171;" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
        ğŸšª
      </button>
      <button class="hamburger-btn" onclick="toggleSidebar()">â˜°</button>
    </div>
  </div>

  <!-- Mobile bottom navigation -->
  <nav class="mobile-bottom-nav" id="mobileBottomNav"></nav>

  <!-- Main -->
  <main class="main">

    <!-- â”€â”€ DASHBOARD TAB â”€â”€ -->
    <div id="dashboardTab" class="hide">
      <div class="page-header">
        <div>
          <div class="page-title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
          <div class="page-subtitle">Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
        </div>
        <!-- ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹ -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <select class="form-select" id="dashFilterType" onchange="renderDashboard()" style="min-width:160px;padding:8px 12px;font-size:13px;">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="Ù…Ø±ÙˆØ±ÙŠØ©">ğŸš— Ù…Ø±ÙˆØ±ÙŠØ©</option>
            <option value="Ø¬Ù†Ø§Ø¦ÙŠØ©">âš–ï¸ Ø¬Ù†Ø§Ø¦ÙŠØ©</option>
            <option value="Ø¹Ø¯Ù…_Ø§Ù„ØªØ²Ø§Ù…">âš ï¸ Ø¹Ø¯Ù… Ø§Ù„ØªØ²Ø§Ù…</option>
            <option value="ØªØµØ§Ø±ÙŠØ­">ğŸ“‹ ØªØµØ§Ø±ÙŠØ­</option>
          </select>
        </div>
      </div>
      <!-- Stat cards -->
      <div class="stats-row" id="statCards"></div>
      <!-- Charts Row 1 -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h3>ğŸ“‹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</h3></div>
          <div class="card-body"><div class="chart-container"><canvas id="chartByType"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>ğŸ“ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</h3></div>
          <div class="card-body"><div class="chart-container" style="height:350px;"><canvas id="chartBySubType"></canvas></div></div>
        </div>
      </div>
      <!-- Charts Row 2 -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h3>âš–ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3></div>
          <div class="card-body"><div class="chart-container"><canvas id="chartByStatus"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>ğŸ“ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h3></div>
          <div class="card-body"><div class="chart-container"><canvas id="chartByZone"></canvas></div></div>
        </div>
      </div>
      <!-- Charts Row 3 -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h3>ğŸ”„ Ø­Ø³Ø¨ Ø§Ù„Ø´ÙØª</h3></div>
          <div class="card-body"><div class="chart-container"><canvas id="chartByShift"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>ğŸ‘¥ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3></div>
          <div class="card-body"><div class="chart-container"><canvas id="chartByGroup"></canvas></div></div>
        </div>
      </div>
      <!-- Charts Row 4 - Companies -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h3>ğŸ¢ Ø£ÙƒØ«Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ø®Ø§Ù„ÙØ©Ù‹ (Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ)</h3></div>
          <div class="card-body"><div class="chart-container" style="height:350px;"><canvas id="chartByCompany"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>ğŸ¢ Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h3></div>
          <div class="card-body"><div class="chart-container" style="height:350px;"><canvas id="chartCompanyByType"></canvas></div></div>
        </div>
      </div>
      <!-- Top Lists -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h3>ğŸ† Ø£Ù†Ø´Ø· Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</h3></div>
          <div class="card-body"><ul class="top-list" id="topInspectors"></ul></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>ğŸ“ˆ Ø£ÙƒØ«Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ø®Ø§Ù„ÙØ©Ù‹</h3></div>
          <div class="card-body"><ul class="top-list" id="topCompanies"></ul></div>
        </div>
      </div>
      <!-- Detailed Sub-type Table -->
      <div class="card" style="margin-top:16px;">
        <div class="card-header"><h3>ğŸ“Š ØªÙØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ§Ù„ÙØ±Ø¹ÙŠ</h3></div>
        <div class="card-body" id="subTypeTable" style="overflow-x:auto;"></div>
      </div>
    </div>

    <!-- â”€â”€ FORM TAB â”€â”€ -->
    <div id="formTab" class="hide">
      <div class="page-header">
        <div>
          <div class="page-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div class="page-subtitle">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ø¯Ù‚Ø©</div>
        </div>
      </div>
      <!-- Success msg -->
      <div class="login-success-msg" id="successMsg">
        <div style="font-size:28px;">âœ…</div>
        <div style="font-size:16px; font-weight:700; color:#34d399; margin-top:8px;">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­!</div>
        <div class="success-ref" id="refNumber"></div>
        <div style="font-size:12px; color:var(--muted);">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ù‚ÙŠØ¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
        <button class="btn-sm btn-pdf" style="margin-top:12px;" onclick="sharePDF()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>âš ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</h3></div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
              <select class="form-select" id="mainViolationType" onchange="updateSubViolations()">
                <option value="">â€” Ø§Ø®ØªØ± â€”</option>
                <option value="Ù…Ø±ÙˆØ±ÙŠØ©">Ù…Ø®Ø§Ù„ÙØ© Ù…Ø±ÙˆØ±ÙŠØ© ğŸš—</option>
                <option value="Ø¬Ù†Ø§Ø¦ÙŠØ©">Ù…Ø®Ø§Ù„ÙØ© Ø¬Ù†Ø§Ø¦ÙŠØ© âš–ï¸</option>
                <option value="Ø¹Ø¯Ù…_Ø§Ù„ØªØ²Ø§Ù…">Ø¹Ø¯Ù… Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠØ© ğŸ—ï¸</option>
                <option value="ØªØµØ§Ø±ÙŠØ­">Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„ØªØµØ§Ø±ÙŠØ­ ğŸ“‹</option>
              </select>
            </div>
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„ÙØ±Ø¹ÙŠ</label>
              <select class="form-select" id="subViolationType" onchange="toggleOtherField()" disabled>
                <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ â€”</option>
              </select>
            </div>
          </div>
          <div class="form-section" id="otherViolationField" style="display:none;">
            <label class="form-label"><span class="req">*</span> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</label>
            <input class="form-input" type="text" id="otherViolationDetail" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©">
          </div>
          <div class="form-section" id="personCountField" style="display:none;">
            <label class="form-label"><span class="req">*</span> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</label>
            <input class="form-input" type="number" id="personCount" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯" min="1" max="100">
          </div>
          <div class="form-grid">
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­</label>
              <select class="form-select" id="permitType">
                <option value="">â€” Ø§Ø®ØªØ± â€”</option>
                <option value="QR">QR Code</option>
                <option value="Ø¨Ø·Ø§Ù‚Ø©">Ø¨Ø·Ø§Ù‚Ø©</option>
                <option value="ÙˆØ±Ù‚ÙŠ">ÙˆØ±Ù‚ÙŠ</option>
                <option value="ÙØ§ØªÙˆØ±Ø© Ù…ÙˆØ±Ø¯">ÙØ§ØªÙˆØ±Ø© Ù…ÙˆØ±Ø¯</option>
                <option value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
                <option value="Ù„Ø§ÙŠÙˆØ¬Ø¯">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
              </select>
            </div>
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
              <select class="form-select" id="zone">
                <option value="">â€” Ø§Ø®ØªØ± â€”</option>
                <option value="Upper Zone">Upper Zone</option>
                <option value="Lower East Zone">Lower East Zone</option>
                <option value="Lower West Zone">Lower West Zone</option>
              </select>
            </div>
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</label>
              <select class="form-select" id="receivingGroup">
                <option value="">â€” Ø§Ø®ØªØ± â€”</option>
                <option value="Group1">Group 1</option>
                <option value="Group2">Group 2</option>
                <option value="Group3">Group 3</option>
                <option value="Group4">Group 4</option>
                <option value="Group A&B">Group A&B</option>
              </select>
            </div>
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ø§Ù„Ø´ÙØª</label>
              <select class="form-select" id="shift">
                <option value="">â€” Ø§Ø®ØªØ± â€”</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
              </select>
            </div>
          </div>
          <!-- Company -->
          <div class="form-section">
            <label class="form-label"><span class="req">*</span> Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
            <input type="hidden" id="companyName">
            <div class="company-wrap">
              <div class="company-trigger" id="companyTrigger" onclick="toggleCompanyDropdown()">
                <span id="companyDisplayText" style="color:var(--muted);">â€” Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© â€”</span>
                <span>â–¾</span>
              </div>
              <div class="company-dropdown" id="companyDropdown">
                <input class="company-search-input" type="text" id="companySearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ©..." oninput="filterCompanies()" onclick="event.stopPropagation()">
                <div id="companyList"></div>
              </div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø®Ø§Ù„Ù</label>
              <input class="form-input" type="text" id="violatorId" placeholder="10 Ø£Ø±Ù‚Ø§Ù…" maxlength="10" oninput="checkRepeatOnForm()">
            </div>
            <div class="form-section">
              <label class="form-label"><span class="req">*</span> Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø®Ø§Ù„Ù</label>
              <input class="form-input" type="tel" id="violatorPhone" placeholder="05xxxxxxxx" maxlength="10">
            </div>
          </div>
          <!-- Plate -->
          <div class="form-section">
            <label class="form-label"><span class="req">*</span> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
            <input type="hidden" id="vehiclePlate">
            <div class="plate-wrap">
              <div class="plate-box">
                <input class="plate-input" type="text" id="plateLetters" placeholder="ABC" maxlength="4"
                  oninput="this.value=this.value.replace(/[^a-zA-Z]/g,'').toUpperCase(); updatePlate(); checkRepeatOnForm()">
                <div class="plate-hint">Ø­Ø±ÙˆÙ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</div>
              </div>
              <div class="plate-sep">â€”</div>
              <div class="plate-box">
                <input class="plate-input" type="text" id="plateNumbers" placeholder="1234" maxlength="4"
                  oninput="this.value=this.value.replace(/[^0-9]/g,''); updatePlate(); checkRepeatOnForm()">
                <div class="plate-hint">Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·</div>
              </div>
            </div>
            <div class="plate-preview" id="platePreview"></div>
          </div>
          <!-- Repeat Alert -->
          <div class="repeat-form-alert" id="formRepeatAlert"></div>
          <!-- Map -->
          <div class="form-section">
            <label class="form-label">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <div class="map-actions">
              <button class="map-btn" type="button" onclick="showMap()">ğŸ—ºï¸ ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
              <button class="map-btn" type="button" onclick="getCurrentLocation()">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
            </div>
            <div id="map" style="display:none;"></div>
            <div class="location-result" id="coordinatesDisplay"></div>
          </div>
          <!-- Images -->
          <div class="form-section">
            <label class="form-label"><span class="req">*</span> ğŸ“¸ ØµÙˆØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Ù…Ø·Ù„ÙˆØ¨ â€” Ø­ØªÙ‰ 6 ØµÙˆØ±)</label>
            <input type="file" id="violationImages" accept="image/*" multiple capture="environment" style="display:none;" onchange="handleImageUpload(event)">
            <div class="upload-btn" id="uploadBtn" onclick="document.getElementById('violationImages').click()" style="cursor:pointer;">
              <span style="font-size:28px;display:block;margin-bottom:4px;">ğŸ“·</span>
              <span style="font-weight:700;">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</span>
              <span style="font-size:11px;opacity:0.7;display:block;margin-top:2px;">JPG / PNG â€” ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø©</span>
            </div>
            <div class="img-preview-grid" id="imagePreview"></div>
            <div id="imgRequiredAlert" style="display:none;color:#f87171;font-size:12px;font-weight:700;margin-top:6px;">âš ï¸ ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>
          </div>
          <button class="btn-primary" onclick="submitViolation()">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</button>
        </div>
      </div>
    </div>

    <!-- â”€â”€ VIOLATIONS LIST TAB â”€â”€ -->
    <div id="myViolationsTab" class="hide">
      <div class="page-header">
        <div>
          <div class="page-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</div>
          <div class="page-subtitle">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
        </div>
      </div>
      <!-- Advanced Filter Bar -->
      <div class="filter-bar">
        <div class="filter-group" style="min-width:200px;flex:2;">
          <label class="filter-label">ğŸ” Ø¨Ø­Ø« Ù†ØµÙŠ</label>
          <input class="filter-input" type="text" id="searchInput" placeholder="Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ØŒ Ù‡ÙˆÙŠØ©ØŒ Ø¬ÙˆØ§Ù„ØŒ Ø´Ø±ÙƒØ©ØŒ Ù…ÙØªØ´..." oninput="applyFilters()">
        </div>
        <div class="filter-group">
          <label class="filter-label">ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select class="filter-select" id="filterStatus" onchange="applyFilters()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            <option value="approved">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</option>
            <option value="rejected">Ù…Ø±ÙÙˆØ¶Ø©</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <select class="filter-select" id="filterZone" onchange="applyFilters()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="Upper Zone">Upper Zone</option>
            <option value="Lower East Zone">Lower East Zone</option>
            <option value="Lower West Zone">Lower West Zone</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">ğŸ”„ Ø§Ù„Ø´ÙØª</label>
          <select class="filter-select" id="filterShift" onchange="applyFilters()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">ğŸ‘¥ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <select class="filter-select" id="filterGroup" onchange="applyFilters()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="Group1">Group 1</option>
            <option value="Group2">Group 2</option>
            <option value="Group3">Group 3</option>
            <option value="Group4">Group 4</option>
            <option value="Group A&B">Group A&B</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">âš ï¸ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</label>
          <select class="filter-select" id="filterType" onchange="applyFilters()">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="Ù…Ø±ÙˆØ±ÙŠØ©">Ù…Ø±ÙˆØ±ÙŠØ©</option>
            <option value="Ø¬Ù†Ø§Ø¦ÙŠØ©">Ø¬Ù†Ø§Ø¦ÙŠØ©</option>
            <option value="Ø¹Ø¯Ù…_Ø§Ù„ØªØ²Ø§Ù…">Ø¹Ø¯Ù… Ø§Ù„ØªØ²Ø§Ù…</option>
            <option value="ØªØµØ§Ø±ÙŠØ­">ØªØµØ§Ø±ÙŠØ­</option>
          </select>
        </div>
        <div class="filter-actions">
          <button class="btn-filter btn-filter-reset" onclick="resetFilters()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        </div>
      </div>
      <div class="filter-result-count" id="filterCount"></div>
      <div id="violationsList"></div>
    </div>

    <!-- â”€â”€ PENDING TAB â”€â”€ -->
    <div id="pendingTab" class="hide">
      <div class="page-header">
        <div><div class="page-title">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div></div>
      </div>
      <div id="pendingList"></div>
    </div>

    <!-- â”€â”€ APPROVED TAB â”€â”€ -->
    <div id="approvedTab" class="hide">
      <div class="page-header">
        <div><div class="page-title">âœ… Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</div></div>
      </div>
      <div id="approvedList"></div>
    </div>

    <!-- â”€â”€ REJECTED TAB â”€â”€ -->
    <div id="rejectedTab" class="hide">
      <div class="page-header">
        <div><div class="page-title">âŒ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</div></div>
      </div>
      <div id="rejectedList"></div>
    </div>

    <!-- â”€â”€ REPORTS TAB â”€â”€ -->
    <div id="reportsTab" class="hide">
      <div class="page-header">
        <div>
          <div class="page-title">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠØ©</div>
          <div class="page-subtitle">Ù…Ù„Ø®Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠÙˆÙ…ÙŠ ÙˆØ£Ø³Ø¨ÙˆØ¹ÙŠ</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn-dl-report" onclick="downloadReport()">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
        </div>
      </div>
      <!-- Period selector -->
      <div class="report-period-btns">
        <button class="btn-period active" id="periodToday" onclick="setReportPeriod('today')">ğŸ“… Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="btn-period" id="periodWeek" onclick="setReportPeriod('week')">ğŸ“† Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button class="btn-period" id="periodMonth" onclick="setReportPeriod('month')">ğŸ—“ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
        <button class="btn-period" id="periodAll" onclick="setReportPeriod('all')">ğŸ“Š Ø§Ù„ÙƒÙ„</button>
      </div>
      <!-- KPI Row -->
      <div class="report-grid" id="reportKPIs"></div>
      <!-- Tables -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header"><h3>ğŸ‘® Ø£Ù†Ø´Ø· Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</h3></div>
          <div class="card-body" id="reportInspectors"></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>ğŸ¢ Ø£ÙƒØ«Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª</h3></div>
          <div class="card-body" id="reportCompanies"></div>
        </div>
      </div>
      <div class="charts-grid" style="margin-top:16px;">
        <div class="card">
          <div class="card-header"><h3>ğŸ“ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</h3></div>
          <div class="card-body" id="reportZones"></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>âš ï¸ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3></div>
          <div class="card-body" id="reportTypes"></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ WHATSAPP SETTINGS TAB â”€â”€ -->
    <div id="waSettingsTab" class="hide">
      <div class="page-header">
        <div>
          <div class="page-title">ğŸ’¬ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
          <div class="page-subtitle">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ’¬ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨</h3></div>
        <div class="card-body">
          <div class="wa-settings">
            <h4>ğŸ“² Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ</h4>
            <div class="wa-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="waEnabled" onchange="saveWASettings()">
                <span class="toggle-slider"></span>
              </label>
              <span style="font-size:13px;color:var(--text);">ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©</span>
            </div>
            <div class="form-section">
              <label class="form-label">ğŸ“± Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø± (Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©)</label>
              <div id="waNumbers">
                <div class="wa-number-row" style="margin-bottom:8px;">
                  <input class="form-input wa-number-input" type="tel" placeholder="Ù…Ø«Ø§Ù„: 966501234567" id="waNum0" onchange="saveWASettings()">
                  <button class="btn-sm btn-pdf" onclick="removeWANumber(0)">ğŸ—‘ï¸</button>
                </div>
              </div>
              <button class="btn-sm btn-approve" style="margin-top:8px;" onclick="addWANumber()">â• Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù…</button>
            </div>
            <div class="form-section" style="margin-top:16px;">
              <label class="form-label">ğŸ“ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
              <textarea class="form-textarea" id="waTemplate" rows="5" onchange="saveWASettings()" style="direction:rtl;">âš ï¸ Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø© â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠØ©
Ø§Ù„Ø±Ù‚Ù…: {refNumber}
Ø§Ù„Ù†ÙˆØ¹: {type}
Ø§Ù„Ø´Ø±ÙƒØ©: {company}
Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: {zone}
Ø§Ù„Ù…ÙØªØ´: {inspector}
Ø§Ù„ÙˆÙ‚Øª: {time}</textarea>
            </div>
            <div style="margin-top:12px;">
              <button class="btn-primary" style="width:auto;padding:12px 28px;" onclick="testWANotification()">ğŸ§ª Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
            </div>
          </div>
          <div style="margin-top:16px; padding:14px; background:rgba(255,255,255,0.03); border-radius:10px; font-size:12px; color:var(--muted);">
            <strong style="color:var(--gold);">ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¹Ù…Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙŠØ¨. Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©ØŒ Ø³ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ ADMIN PANEL TAB â”€â”€ -->
    <div id="adminPanelTab" class="hide">
      <div class="page-header">
        <div>
          <div class="page-title">ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³Ø±ÙŠ</div>
          <div class="page-subtitle">ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© â€” Admin Access Only</div>
        </div>
        <button class="btn-sm btn-pdf" onclick="exportAdminReport()" style="padding:10px 18px;font-size:13px;">ğŸ“Š ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
      </div>
      <div id="adminPanelContent"></div>
    </div>

  </main>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPERVISOR_CODES = {
    "G1-2026": "Group1",
    "G2-2026": "Group2",
    "G3-2026": "Group3",
    "G4-2026": "Group4",
    "AB-2026": "Group A&B",
    "QDY-ADMIN-2026": "admin"
};
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkRWtY80EgmAo3p3TvNDX7KxiOjWuF-GyjdR6w_ZLCDCoKSzyWlyoxGbqE5ariOALL/exec';

const allUsers = {
    "ADMIN": { name: "Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… â€” Admin", password: "Qdy#9471@Admin", role: "admin" },
    "10429": { name: "Naif Faisal Saleh Alharbi", password: "236908", role: "employee" },
    "11827": { name: "Abdulhadi Mahdi Al-Qahtani", password: "556340", role: "employee" },
    "12923": { name: "Rakan Bandar Talal Al-Mutairi", password: "935056", role: "employee" },
    "13182": { name: "Sufayran Mesfer Alhuzri", password: "496130", role: "employee" },
    "13342": { name: "Ahmed Abdu Mater", password: "513605", role: "employee" },
    "13359": { name: "Muteb A'id Said Al-Qahtani", password: "941556", role: "employee" },
    "13360": { name: "Omar theeb Alqahtani", password: "773867", role: "employee" },
    "13362": { name: "Nasser Abdullah Alqahtani", password: "388952", role: "employee" },
    "13363": { name: "Nasser Hamoud Al-qahtani", password: "860145", role: "employee" },
    "13364": { name: "Ziad mohamed Alnuaimi", password: "567181", role: "employee" },
    "13365": { name: "Mardhi A'id Al-Qahtani", password: "825175", role: "employee" },
    "13367": { name: "Nayef Saad Hamoud AlQahtani", password: "573735", role: "employee" },
    "13368": { name: "Ali Saeed Ayed Al Zaidani", password: "351164", role: "employee" },
    "13369": { name: "Jamal bejad Alqahtani", password: "399567", role: "employee" },
    "13373": { name: "Fahhad Mosfer Alatffi", password: "990984", role: "employee" },
    "13374": { name: "Munahi Ali Alqahtani", password: "228346", role: "employee" },
    "13376": { name: "Ryan Turki Ameen", password: "839398", role: "employee" },
    "13378": { name: "Sahmi Musnad Alsubaie", password: "844598", role: "employee" },
    "13379": { name: "Saad Hussain Saad Alsubaie", password: "184099", role: "employee" },
    "13383": { name: "Saad Mohammed Al-Qahtani", password: "101008", role: "employee" },
    "13387": { name: "Mohmaad Aloush Alsubaie", password: "363356", role: "employee" },
    "13388": { name: "Hatim Ali Albishi", password: "648743", role: "employee" },
    "13389": { name: "Deefallah Abdullah Alharbi", password: "551160", role: "employee" },
    "13391": { name: "Zaid Saif Zaid Al-Suwailih AlRashid", password: "161850", role: "employee" },
    "13397": { name: "Sattam Muneer Alqahtani", password: "303857", role: "employee" },
    "13400": { name: "Raed Ayidh Alqahtani", password: "118402", role: "employee" },
    "13401": { name: "Badi Khalid Said Al-Otaibi", password: "860532", role: "employee" },
    "13402": { name: "Abdulrahman A. Alharbi", password: "870905", role: "employee" },
    "13405": { name: "Basil Bandar Abdulrahman Al-Huwaimel", password: "361900", role: "employee" },
    "90001": { name: "Sultan Bejad Alqahtani", password: "741852", role: "employee" },
    "13406": { name: "Abdulaziz Dhafir Al-Qahtani", password: "754279", role: "employee" },
    "13408": { name: "Bander Bijad Alqahtani", password: "618178", role: "employee" },
    "13409": { name: "Mohammed Al-Farsani", password: "665466", role: "employee" },
    "13411": { name: "Khalid Mu'id  Al-Turbush", password: "836309", role: "employee" },
    "13412": { name: "Jamaan Saleh Alqahtani", password: "707367", role: "employee" },
    "13414": { name: "Jazaa Habbab Alqahtani", password: "473039", role: "employee" },
    "13417": { name: "Khalid Abdulaziz Al-Qahtani", password: "561526", role: "employee" },
    "13418": { name: "Turki Farhan Alqahtani", password: "357489", role: "employee" },
    "13421": { name: "Jaber Mohammed Alalyani", password: "953146", role: "employee" },
    "13422": { name: "Faisal Saleh Alqarni", password: "366004", role: "employee" },
    "13423": { name: "Abdullah Mohammed Al Qahtani", password: "428696", role: "employee" },
    "13425": { name: "Abdulkhaleq Alghamdi", password: "978246", role: "employee" },
    "13429": { name: "Farraj A'id Faraj Al-Shahrani", password: "566935", role: "employee" },
    "13435": { name: "Fahad Snetan Alotaibi", password: "787007", role: "employee" },
    "13437": { name: "Abdullah Omar Al-Subaie", password: "978216", role: "employee" },
    "13440": { name: "Abdulaziz Abdullah Alkhudhayri", password: "699445", role: "employee" },
    "13445": { name: "Abdulrahman Muthkar Alhajri", password: "287527", role: "employee" },
    "13449": { name: "Hezam Fahad Alqahtani", password: "367979", role: "employee" },
    "13451": { name: "Ghalib Mohammed Alqahtani", password: "356407", role: "employee" },
    "13452": { name: "Naif Hassan Alwuthaylah", password: "880070", role: "employee" },
    "13453": { name: "Sahmi Saeed Alqahtani", password: "488715", role: "employee" },
    "13454": { name: "Abdulaziz Mohaimeed Alotaibi", password: "456871", role: "employee" },
    "13455": { name: "Mar'i Ali Hassan Mu'afa", password: "114685", role: "employee" },
    "13457": { name: "Salah Abdulaziz Mohammed Al Monif", password: "267808", role: "employee" },
    "13713": { name: "Muhammad Nasser Al-Ghamdi", password: "687901", role: "employee" },
    "13714": { name: "Youssef Hammoud Al-Rasheed", password: "806762", role: "employee" },
    "13715": { name: "Fahad Ibrahim Ali Al-Ajam", password: "241193", role: "employee" },
    "13718": { name: "Nasser Mubarak Al-Qahtani", password: "505864", role: "employee" },
    "13722": { name: "Nader Hussein Al-Abd Al-Qahtani", password: "899334", role: "employee" },
    "13732": { name: "Sager Mohammed Al Qahtani", password: "185289", role: "employee" },
    "13733": { name: "Omar Samil Almoqati", password: "883229", role: "employee" },
    "13736": { name: "Zamel hathal Alsubaie", password: "831513", role: "employee" },
    "13739": { name: "Masoud Misfer Saeed Al Yami", password: "438101", role: "employee" },
    "13903": { name: "Mohammed Haif Monaif Alotaibi", password: "588494", role: "employee" },
    "13915": { name: "Ibrahim Mohammad Al Qahtani", password: "669940", role: "employee" },
    "14031": { name: "Fuhaid Abdullah Alsubaie", password: "304665", role: "employee" },
    "14189": { name: "Abdulaziz Rafi Al Shehri", password: "761843", role: "employee" },
    "14191": { name: "Abdallah Raed Mohammed Al-Shammari", password: "543063", role: "employee" },
    "14192": { name: "Abdulhadi Mohammad Al-Ghabawi", password: "492545", role: "employee" },
    "14196": { name: "Mohammad Ali Mohammad Al-Qahtani", password: "231211", role: "employee" },
    "14676": { name: "Mohammad Misfer Hamad Al-Qahtani", password: "850763", role: "employee" },
    "14677": { name: "Ali Shaddad Muhammad Al-Qahtani", password: "436843", role: "employee" },
    "14678": { name: "Adel Jaber Ahmed Aqeeli", password: "160548", role: "employee" },
    "14679": { name: "Fayez Ali Hassan Fasal", password: "513680", role: "employee" },
    "14684": { name: "Fanjal Ayed Nawar Al-Shaibani", password: "779581", role: "employee" },
    "15069": { name: "Youssef Ali Abdulrahman Al-Shehri", password: "504712", role: "employee" },
    "15134": { name: "Saud Awad Malfi Al-Anzi", password: "779723", role: "employee" },
    "15465": { name: "Sultan Ahmed Mohammad Al-Ajam", password: "538766", role: "employee" },
    "15478": { name: "Abduirahman Haji Saud Al Shammari", password: "759772", role: "employee" },
    "15556": { name: "Awad Zaid Shadid Al-Harbi", password: "440729", role: "employee" },
    "15696": { name: "Salah Sattam Menzel Al-Shammari", password: "932904", role: "employee" },
    "15976": { name: "Fahad Mohammed Abdullah Al-Qahtani", password: "372225", role: "employee" },
    "15977": { name: "Fahad Mohammed Ahmed Al-Anzi", password: "954918", role: "employee" },
    "16065": { name: "Ayedh  Sultan bin Obaisan Al-Baqmi", password: "267169", role: "employee" },
    "16139": { name: "Abdullah Hassan AlShabawi", password: "596834", role: "employee" },
    "16288": { name: "Mansour Ayed AlKhanfari", password: "442597", role: "employee" },
    "16474": { name: "Turki Rahil Faraj Al-Mutarfi", password: "757157", role: "employee" },
    "16516": { name: "Ahmed Abdullah Alrashidi", password: "117253", role: "employee" },
    "16517": { name: "Faisal Rakan Alqahtani", password: "248789", role: "employee" },
    "16518": { name: "Badr Hamdan Hamad Al-Nafie", password: "273453", role: "employee" },
    "16519": { name: "Ahmed Muslam Aljafri", password: "679202", role: "employee" },
    "16520": { name: "Abdulaziz Salem Hassan Alqahtani", password: "721431", role: "employee" },
    "16521": { name: "Abdullah Dhaar Alsubai", password: "443854", role: "employee" },
    "16524": { name: "Khalid Hamoud Almutairi", password: "242152", role: "employee" },
    "16579": { name: "Khaled Ayed Eid Al-Qahtani", password: "351143", role: "employee" },
    "16598": { name: "Ahmed Ali Alshahrani", password: "658823", role: "employee" },
    "16599": { name: "Rashid Omar Al-Lailah", password: "138613", role: "employee" },
    "16600": { name: "Sultan Matar Sahoud", password: "312498", role: "employee" },
    "16601": { name: "Ali Hamoud Ali Al-Halafi", password: "982918", role: "employee" },
    "16602": { name: "Hamed Saleh Alqahtani", password: "366958", role: "employee" },
    "16604": { name: "Mubarak Bakhit Fahad Al Dosari", password: "189056", role: "employee" },
    "16607": { name: "Mutab Jafar Alqahtani", password: "517823", role: "employee" },
    "16608": { name: "Turki Naif Al-Qahtani", password: "433189", role: "employee" },
    "16610": { name: "Fahad Abdulmahsan Alqahtani", password: "134127", role: "employee" },
    "17197": { name: "Rakan Nasser Jaithan Al-Otaibi", password: "868026", role: "employee" },
    "17203": { name: "Nader Khalid Faleh Al-Dosari", password: "566216", role: "employee" },
    "17206": { name: "Abdulaziz Abdulrahman Al-Mohsen", password: "164005", role: "employee" },
    "17224": { name: "Mohammed Abdulaziz Nasser Al-Omar", password: "693077", role: "employee" },
    "17295": { name: "Abdullah Fahid Saleh Al-Ghaidani", password: "469269", role: "employee" },
    "17302": { name: "Mohsen Naji Mohsen Al-Harthi", password: "414892", role: "employee" },
    "17447": { name: "Moayyad Hamad Mohammed Al-Qahtani", password: "338788", role: "employee" },
    "17454": { name: "Hassan Hamoud Fahd Al-Hathal", password: "658167", role: "employee" },
    "17530": { name: "Khaled Abdulrahman Alkhalifa", password: "523652", role: "employee" },
    "17533": { name: "Yousef Falhan Al-Harthi", password: "437080", role: "employee" },
    "17535": { name: "Ayob Basrallah Mohammed Al-Shaher", password: "744954", role: "employee" },
    "17536": { name: "Fahad Saleh Alqahtani", password: "637360", role: "employee" },
    "17544": { name: "Mishari Mohammed Al-Qahtani", password: "152835", role: "employee" },
    "17546": { name: "Abdulrahman Saeed Al-Qahtani", password: "417610", role: "employee" },
    "17547": { name: "Abdulaziz Ghaleb Suwaileh Al-Harbi", password: "357930", role: "employee" },
    "17548": { name: "Mishaal Sedah Mohammed Al-Qahtani", password: "556392", role: "employee" },
    "17551": { name: "Abdulsalam Abdulkarim Nashi Al-Rashidi", password: "590177", role: "employee" },
    "17834": { name: "Hamoud Misfer Jafen Al-Qahtani", password: "237842", role: "employee" },
    "17836": { name: "Hamoud Saad Salem Al-Qahtani", password: "203850", role: "employee" },
    "17840": { name: "Abdullah Muzaybin Nawar Al-Otaibi", password: "587157", role: "employee" },
    "17842": { name: "Salman Abdullah Ali Ashib", password: "100653", role: "employee" },
    "17851": { name: "Sultan Suleiman Abdulaziz", password: "611758", role: "employee" },
    "17853": { name: "Nawaf Abdullah Zayed Al-Otaibi", password: "661460", role: "employee" },
    "17871": { name: "Mohammed Ibrahim Al Rashidi", password: "290550", role: "employee" },
    "17996": { name: "Ahmed Essa Abdullah Al Zahrani", password: "602266", role: "employee" },
    "18063": { name: "Muqbil Ali Muqbil Al-Qahtani", password: "238555", role: "employee" },
    "18200": { name: "Mohammed Dakhil Saud Al-Qahtani", password: "907196", role: "employee" },
    "18201": { name: "Sultan Hadi Ghayed Al-Qahtani", password: "569588", role: "employee" },
    "18202": { name: "Ryan Ayman Mahdi Mohammed", password: "811909", role: "employee" },
    "18203": { name: "Faisal Saad Nasser Al-Dosari", password: "841573", role: "employee" },
    "18239": { name: "Amar Mohammed Abdullah Al-Dosari.", password: "616628", role: "employee" },
    "18402": { name: "Khaled Mohammed Saeed Al-Qahtani", password: "807877", role: "employee" },
    "18403": { name: "Salem Mubarak Fahad Al-Qahtani", password: "996430", role: "employee" },
    "18405": { name: "Abdullah Abdulhadi Jaligham", password: "208065", role: "employee" },
    "18409": { name: "Abdulaziz Saad Al-Rajeh", password: "223459", role: "employee" },
    "18410": { name: "Omar Mohammed Omar Al-Tamimi", password: "192927", role: "employee" },
    "18411": { name: "Abdulrahman Safar Hassan Al-Harthi", password: "413367", role: "employee" },
    "18412": { name: "AlWalid Hussein Saeed Al-Shahrani", password: "536936", role: "employee" },
    "18413": { name: "Ali Amer Dhafer Al-Qushairy", password: "180239", role: "employee" },
    "18417": { name: "Malefe Lafi Salman Al-Otaibi", password: "496806", role: "employee" },
    "18418": { name: "Ahmed Hussein Ahmed Al-Khaiwani", password: "191601", role: "employee" },
    "18419": { name: "Khaled Omar Marjah Al-Baqmi", password: "696147", role: "employee" },
    "18420": { name: "Mishaal Jabbar Saadi Al-Ghamdi", password: "479846", role: "employee" },
    "18550": { name: "Mohammed Abdullah Mosfer Alsubaie", password: "521809", role: "employee" },
    "18592": { name: "Thamer Ali Fayez Al-Shahrani", password: "922411", role: "employee" },
    "18593": { name: "Raed Mutrib Owaidh alomairi", password: "562964", role: "employee" },
    "18594": { name: "Mohanned Yahya Madkhali", password: "953720", role: "employee" },
    "18595": { name: "Amjad Batal Ghali Al-Mutairi", password: "800761", role: "employee" },
    "18596": { name: "Azzam Fahd Sunhat Al-Harbi", password: "138556", role: "employee" },
    "18597": { name: "Abdulmajeed Mohammed Abdullah Al-AsimI", password: "891549", role: "employee" },
    "18599": { name: "Taher Hilal Wasal Al-Rubaie", password: "729150", role: "employee" },
    "18602": { name: "Aboud bin Hamad bin Saeed Al-Dosari", password: "658998", role: "employee" },
    "18604": { name: "Faris Faleh Baraka Al Harbi", password: "946981", role: "employee" },
    "18605": { name: "Ahmed Faleh Baraka Al Harbi", password: "248018", role: "employee" },
    "18606": { name: "Abdullah Nasser Mohammed Al-Qahtani", password: "335970", role: "employee" },
    "18608": { name: "Hamad Mubarak Fadhi Al-Rashidi", password: "189604", role: "employee" },
    "18609": { name: "Sami Ayed Saud Al-Harbi", password: "627424", role: "employee" },
    "18610": { name: "Khaled Mohammed Hassan Al-Harbi", password: "746717", role: "employee" },
    "18611": { name: "Ahmed bin Muhammad bin Ahmed Bahari", password: "559117", role: "employee" },
    "18612": { name: "Khaled Ghazi Shabab Al-Shaibani", password: "749235", role: "employee" },
    "18613": { name: "Ali Saeed Mohammed Al-Ahmari", password: "404301", role: "employee" },
    "18614": { name: "Faisal Ali Mubarak Al-Ahmari", password: "394257", role: "employee" },
    "18617": { name: "Abdulillah Mufreh Saeed Al-Suhaim", password: "138390", role: "employee" },
    "18618": { name: "Fahd Rashid Ibrahim Al-Samel", password: "970075", role: "employee" },
    "18627": { name: "Abdulaziz Mukhaizeem Faraj Al-Qahtani", password: "234373", role: "employee" },
    "18637": { name: "Saad Ayed Faisal Al-Qahtani", password: "621280", role: "employee" },
    "18642": { name: "Mubarak Nasser Mohammed Al-Qahtani", password: "749501", role: "employee" },
    "18644": { name: "Saud Haif Hadi Alsubaie", password: "907663", role: "employee" },
    "90002": { name: "Fahd Salem Mohammed Al-Jaghwani", password: "635274", role: "employee" },
    "18645": { name: "Fawaz Abdullah Fawaz Al-Dosari", password: "238693", role: "employee" },
    "18646": { name: "Khaled Hassan Jabran Qabouli", password: "370603", role: "employee" },
    "18647": { name: "Abdulkarim Idris Bakr Adam", password: "105623", role: "employee" },
    "18648": { name: "Badr Atiq Zaid Al-Baqmi", password: "117823", role: "employee" },
    "18649": { name: "Khaled Majed Mohammed Al-Mubarak", password: "449106", role: "employee" },
    "18657": { name: "kudaysi Hamad Abdullah Al-Abbas", password: "202218", role: "employee" },
    "90003": { name: "Ali Hamad Hadi Hamad Al-Qahtani", password: "489013", role: "employee" },
    "18710": { name: "Nayef Sultan Obaisan Al-Baqmi", password: "494020", role: "employee" },
    "18727": { name: "Osama Mohammed Hamdan Al-Harbi", password: "372123", role: "employee" },
    "18728": { name: "Faris Mohammed Shaalan Al-Qarni", password: "924089", role: "employee" },
    "18731": { name: "Hamdan Saeed Mohammed Al-Hazri", password: "342434", role: "employee" },
    "18732": { name: "Mohammed Hamoud Faleh Al-Otaibi", password: "363032", role: "employee" },
    "18734": { name: "Mishbab bin Mubarak bin Mishbab Al-Dosari", password: "534059", role: "employee" },
    "18737": { name: "Abdullah Salem Al-Qahtani", password: "327393", role: "employee" },
    "18740": { name: "Nayef Hussein Sharif Al-Khalidi", password: "230022", role: "employee" },
    "18795": { name: "Saud Ibrahim Saud Al-Qahtani", password: "717412", role: "employee" },
    "18814": { name: "Ahmed Khalaf Saleh Al-Mahous", password: "462420", role: "employee" },
    "18866": { name: "Abdullah Mani Mohammed Al-Shabwi", password: "717019", role: "employee" },
    "18867": { name: "Ryan Saad Khalid Al-Hamali", password: "515134", role: "employee" },
    "18975": { name: "Dhaher Hamoud Dahwi Al-Shammari", password: "444849", role: "employee" },
    "18996": { name: "Badr Rashid Bajah Al-Rashidi", password: "900888", role: "employee" },
    "19000": { name: "Khalid Dhafir Hadi Al-Qahtani", password: "768312", role: "employee" },
    "19001": { name: "Ziad Baraka Onaizan Al-Rashidi", password: "378414", role: "employee" },
    "19002": { name: "Waleed Mufrih Al-Shaheeri", password: "651852", role: "employee" },
    "19003": { name: "Ali Ammar Ali Al-Rashidi", password: "602762", role: "employee" },
    "19005": { name: "Abdulhadi Faleh Abdulmane Al-Qahtani", password: "291887", role: "employee" },
    "19007": { name: "Muqrin Fahd Hamdan Al-Harbi", password: "519277", role: "employee" },
    "19008": { name: "Dhafer Hadi Ayed Al-Shabwi", password: "743465", role: "employee" },
    "90004": { name: "Abdullah Dhafer Abdulhadi Al-Shahri", password: "327916", role: "employee" },
    "19009": { name: "Ali Saeed Abdullah Al-Shehri", password: "257558", role: "employee" },
    "19010": { name: "Fahd Abdullah Ali Al-Qadi", password: "184369", role: "employee" },
    "19013": { name: "Fahd Fahid Fahd Al-Saadi", password: "566194", role: "employee" },
    "19050": { name: "Fahad Abdullah Alshabani", password: "899243", role: "employee" },
    "19051": { name: "Abdulmajeed Moraie Ajran Alrathwan", password: "687652", role: "employee" },
    "19052": { name: "Khalid Ismail Misfer Al-Dosari", password: "229658", role: "employee" },
    "19066": { name: "Nidaa Rabah Mohsen Al-Harbi", password: "631512", role: "employee" },
    "90005": { name: "Abdulrahman Al-Saaran", password: "562038", role: "employee" },
    "19132": { name: "Mohammed Saud Fayyad Al-Enezi", password: "240474", role: "employee" },
    "19133": { name: "Yousef Mubarak Satm Al-Harbi", password: "733822", role: "employee" },
    "19135": { name: "Faisal Abdulrazzaq Jazaa Al-Shammari", password: "731447", role: "employee" },
    "19139": { name: "Mishaal Mohammed Zayed Al-Mutairi", password: "682009", role: "employee" },
    "19140": { name: "Mardi Saad Mazid Al-Enezi", password: "667416", role: "employee" },
    "19141": { name: "Sultan Nasser Shaman Al-Barak Al-Rashidi", password: "322257", role: "employee" },
    "19142": { name: "Nasser Hussein Kumaihan Al-Dosari", password: "968799", role: "employee" },
    "19146": { name: "Mohammed Khaled Mansour Al-Hanabija", password: "640354", role: "employee" },
    "19147": { name: "Talal Hadian Rashid Al-Shakra", password: "489851", role: "employee" },
    "19149": { name: "Abdullah Fayez Abdullah Al-Dosari", password: "762982", role: "employee" },
    "19150": { name: "Fahd Mohammed Sabbar Alshammari", password: "731221", role: "employee" },
    "19151": { name: "Abdulaziz Saud Farhan Al-Harbi", password: "690457", role: "employee" },
    "19152": { name: "Abdullah Ibrahim Saeed Al-Ghannoum", password: "910075", role: "employee" },
    "19153": { name: "Mishaal Mohammed Rajih Al-Otaibi", password: "835932", role: "employee" },
    "19155": { name: "Muath Abdo Mohammed Halawi Sharahili", password: "250901", role: "employee" },
    "19196": { name: "Abdullah Mahdi Abdullah Al-Dosari", password: "356076", role: "employee" },
    "19197": { name: "Abdulaziz Muhammad Abdullah Al-Maliki", password: "705576", role: "employee" },
    "19198": { name: "Mardi Abdulaziz Dahwi Al-Shammari", password: "896166", role: "employee" },
    "19199": { name: "Nasser Najr Eid Al-Jumaili", password: "899679", role: "employee" },
    "19200": { name: "Fahd Misfer Fahed Al-Aliani", password: "655366", role: "employee" },
    "19202": { name: "Hussein Muhammad Ali Al-Shamrani", password: "715220", role: "employee" },
    "19204": { name: "Badr Baniyah Mukhlif Al Shamri", password: "106339", role: "employee" },
    "19208": { name: "Abdulwahab Muhammad Mutlaq Al-Dosari", password: "900101", role: "employee" },
    "19251": { name: "Bassam Obaid Mahshi Alanazi", password: "284838", role: "employee" },
    "19285": { name: "Naif Falah Musfer Al-Qahtani", password: "671362", role: "employee" },
    "19286": { name: "Musfer Faisal Mohsen Al-Qahtani", password: "619022", role: "employee" },
    "19287": { name: "Abdulaziz Ahmed Ali Najmi", password: "237217", role: "employee" },
    "19289": { name: "Omar Awad Abdullah Al-Anzi", password: "398050", role: "employee" },
    "19290": { name: "Mohammed Hammad Saleh Alballaji", password: "510715", role: "employee" },
    "19295": { name: "Mohammed Faleh Ayedh Alqahtani", password: "850330", role: "employee" },
    "19297": { name: "Sultan Wazie Radhi Alqahtani", password: "449718", role: "employee" },
    "19299": { name: "Saeed Mohammed Ibrahim Alamari", password: "360882", role: "employee" },
    "19300": { name: "Khaled Dhaifallah Rzaieq Almokhlafi", password: "806378", role: "employee" },
    "19302": { name: "Muteeb Musfer Mohammed Al-Asimi", password: "497582", role: "employee" },
    "19305": { name: "Hamad Hassan Hamad Alqahtani", password: "605428", role: "employee" },
    "19307": { name: "Mufleh Abdullah Mohammed Alqahtani", password: "220873", role: "employee" },
    "19308": { name: "Mohannad Falah Hamid Al-Shahrani", password: "990057", role: "employee" },
    "19309": { name: "Nawaf Ajean Hadeef Al-Otaibi", password: "731588", role: "employee" },
    "19310": { name: "Abduullah Sarrai Jarallah Alshammari", password: "699681", role: "employee" },
    "19311": { name: "Abdullah Shaiaan Hamed Alshammari", password: "663749", role: "employee" },
    "19313": { name: "Abdulrahman Mufleh Faleh Alrashidi", password: "238269", role: "employee" },
    "19322": { name: "Turki Abdulaziz Nasser Aldawsari", password: "703099", role: "employee" },
    "19323": { name: "Ahmed Abdulelah Fairooz Alfairooz", password: "412680", role: "employee" },
    "19324": { name: "Hmoud Mohammed Ghazi Alotaibi", password: "215508", role: "employee" },
    "19325": { name: "Salem Dhafir Abdullah Al-Qahtani", password: "554189", role: "employee" },
    "90006": { name: "Hussain khaled Hussain Alsaleh", password: "356787", role: "employee" },
    "19331": { name: "Faisal Abdullah Dhaifallah Alharbi", password: "764747", role: "employee" },
    "19340": { name: "Sultan Saad Abdullah Alshali", password: "901454", role: "employee" },
    "19341": { name: "Fahd Mohammed Awad Al-Mutairi", password: "998525", role: "employee" },
    "19356": { name: "Khalid Mubarak Mohsen Al-Dosari", password: "537569", role: "employee" },
    "19360": { name: "Al-Hussein Ali Yahya Jabari", password: "169674", role: "employee" },
    "19363": { name: "Yazeed Hamad Atiah Al-Anzi", password: "668245", role: "employee" },
    "90007": { name: "Khalid Dhafer A'id Al-Qahtani", password: "334053", role: "employee" },
    "19371": { name: "Abdullah Jabran Hatrosh Al-Maliki", password: "507203", role: "employee" },
    "19372": { name: "Sami Hassan Jabir", password: "827634", role: "employee" },
    "19373": { name: "Mohammed Mansour Mohammed Al-Ratqi", password: "257862", role: "employee" },
    "19375": { name: "Abdullah Amash Samran Al-Mutairi", password: "485338", role: "employee" },
    "19376": { name: "Ibrahim Mohammed Abdullah Al-Mutairi", password: "924511", role: "employee" },
    "19377": { name: "Faris Fahid Maayouf Al-Qahtani", password: "593409", role: "employee" },
    "19378": { name: "Abdulrahman Salman Abdulrahman bin Salman", password: "432369", role: "employee" },
    "19389": { name: "Naif Muneef Naif Al-Hamadi", password: "484961", role: "employee" },
    "19393": { name: "Mohammed Abdulrahman Mohammed Al-Shahri", password: "145276", role: "employee" },
    "19394": { name: "Falih Mohammed Falih Al-Mahdani", password: "605903", role: "employee" },
    "19400": { name: "Faisal Salem Al-Qahtani", password: "152103", role: "employee" },
    "19401": { name: "Abdullah Obaid Al-Qahtani", password: "838182", role: "employee" },
    "19402": { name: "Mubarak Awda Mohammed Al-Shahrani", password: "609514", role: "employee" },
    "19413": { name: "Ahmed Mosaad Aida Al-Malki", password: "516182", role: "employee" },
    "19542": { name: "Sultan Mohammed Metriq Almaawi", password: "293146", role: "employee" },
    "19543": { name: "Faisal Aqal Altemyani", password: "289134", role: "employee" },
    "19550": { name: "Fahad Mohammed Mlaif Alsubaie", password: "842547", role: "employee" },
    "19551": { name: "Mohammed Fahad Abdullah Alessa", password: "254602", role: "employee" },
    "19559": { name: "Bander Moshabbeb Mohammed Alqahtani", password: "250849", role: "employee" },
    "19560": { name: "Nader Mohammed Taher Talbi", password: "259319", role: "employee" },
    "19566": { name: "Faris Naif Alotaibi", password: "573683", role: "employee" },
    "19568": { name: "Wafi Aiesh Alanezi", password: "220417", role: "employee" },
    "19569": { name: "Muteb Yahya Muteb Al-Murmash", password: "780676", role: "employee" },
    "19571": { name: "Adel Saad Saeed Alqahtani", password: "700957", role: "employee" },
    "19658": { name: "Faisal Mohammed  Mas'ood Al-Mansoor", password: "820515", role: "employee" },
    "19660": { name: "Nasser bin Ahmad bin Nasser Al-Mutawa", password: "849959", role: "employee" },
    "19662": { name: "Mohammed Fahd Abdullah Al-Mughamm", password: "176832", role: "employee" },
    "19705": { name: "Bader Hadi Hassan Al-Qahtani", password: "262931", role: "employee" },
    "19706": { name: "Abdulrahman Yahya Abdulrahman Hamdi", password: "714009", role: "employee" },
    "19708": { name: "Naif Mansour Qbeil Al-Shammari", password: "155260", role: "employee" },
    "19760": { name: "Obaidullah Abdulhamid Obaidullah Al-Rashedi", password: "490189", role: "employee" },
    "19761": { name: "Walid Saif Abdulrahman Al-Abisi", password: "561791", role: "employee" },
    "19762": { name: "Thamer Rashid Jarallah Al-Suhaili", password: "814048", role: "employee" },
    "19763": { name: "Majed Ashwan Qaid Al-Anzi", password: "164451", role: "employee" },
    "19764": { name: "Mohammed Zaher Ali Al-Barqi", password: "973180", role: "employee" },
    "19765": { name: "Mohammed Sardi Saadi Al-Rimali Al-Shammari", password: "999513", role: "employee" },
    "19766": { name: "Waleed Saeed Masoud Al-Qahtani", password: "804564", role: "employee" },
    "19767": { name: "Sari Saleh Eid Al-Nuhaity Al-Harbi", password: "269815", role: "employee" },
    "19768": { name: "Mansour Abdullah Mohammed Al-Qahtani", password: "240828", role: "employee" },
    "19769": { name: "Salem Suleiman Salem Al-Omairi", password: "298998", role: "employee" },
    "19771": { name: "Muneef Naif Naif Al-Qahtani", password: "589805", role: "employee" },
    "19772": { name: "Abdullah Salem Abdullah Al-Waked", password: "238646", role: "employee" },
    "90008": { name: "Mishaal Mohammed Miyah Al-Shammari", password: "246316", role: "employee" },
    "19773": { name: "Faisal Mithal Ibrahim Al-Qahtani", password: "666792", role: "employee" },
    "90009": { name: "Khaled Bassam Al-Anzi", password: "872246", role: "employee" },
    "19778": { name: "Abdulaziz Nasser Sagheer Al-Shammari", password: "545120", role: "employee" },
    "19779": { name: "Aaidh Mohammed Shujaa Al-Subaie", password: "892701", role: "employee" },
    "19782": { name: "Tareq Sayer Hamoud Al-Shammari", password: "862744", role: "employee" },
    "19785": { name: "Farraj bin Nashaa bin Farraj Al-Subaie", password: "979185", role: "employee" },
    "19787": { name: "Bandar Atiq Farih Al-Shammari", password: "568930", role: "employee" },
    "90010": { name: "Omar Sahil Omar Al-Omairi", password: "207473", role: "employee" },
    "19788": { name: "Mishaal Ibrahim Mani Al-Shammari", password: "800079", role: "employee" },
    "19789": { name: "Mani Aydh Faleh Al-Qahtani", password: "769302", role: "employee" },
    "19790": { name: "Waleed Khalid Jihad Al-Anzi", password: "364268", role: "employee" },
    "19791": { name: "Abdulaziz Fahid Jaafar Al-Qahtani", password: "639005", role: "employee" },
    "19792": { name: "Faisal Ghanem Mushai Al-Shibani", password: "360652", role: "employee" },
    "19793": { name: "Ahmed bin Khalid bin Muhammad - Al-Qahtani", password: "132343", role: "employee" },
    "19794": { name: "Bandar Ali Aaidh Al-Shahrani", password: "474837", role: "employee" },
    "19795": { name: "Sultan Ayed mohammed Aloaayani", password: "180893", role: "employee" },
    "19796": { name: "Bandar Faraj Mohammed Al-Shahrani", password: "624492", role: "employee" },
    "19797": { name: "Salman Ghannam Hassan Al-Qahtani", password: "803591", role: "employee" },
    "19841": { name: "Nawaf Fahd Faraj Al-Qahtani", password: "603921", role: "employee" },
    "19842": { name: "Abdullah Jaser Hajad Al-Buqami", password: "618894", role: "employee" },
    "19843": { name: "Faisal Mohammed Fahd Al-Qahtani", password: "529997", role: "employee" },
    "19844": { name: "Fahd Saad Aydh Al-Qahtani", password: "691551", role: "employee" },
    "19845": { name: "Mohammed Misfer Fahid Al-Olayani Al-Qahtani", password: "693198", role: "employee" },
    "19846": { name: "Mohammed Ali Saleh Al-Shehri", password: "696492", role: "employee" },
    "19855": { name: "Abdulwahab Hussein Salem Al-Zahrani", password: "805946", role: "employee" },
    "19857": { name: "Eid Abdullah Eid Al-Otaibi", password: "641856", role: "employee" },
    "90011": { name: "Jihad Burkan Al Waqian", password: "713485", role: "employee" },
    "90012": { name: "Mohammad Ahmad Jubran Al Qahtani", password: "876646", role: "employee" },
    "19860": { name: "Misfer Mutlaq Misfer Al-Dosari", password: "210165", role: "employee" },
    "19861": { name: "Saad Mohammed Salem Al-Qahtani", password: "906639", role: "employee" },
    "19863": { name: "Abdullah Obaid Mohammed Al-Shahrani", password: "280460", role: "employee" },
    "19865": { name: "Mohammed Jaber Mohammed Al-Fifi", password: "338850", role: "employee" },
    "19866": { name: "Mohammed Najm Dhafer Al-Shahrani", password: "249015", role: "employee" },
    "19867": { name: "Ahmed Ali Ahmed Al-Nukhaifi", password: "232892", role: "employee" },
    "19869": { name: "Abdulaziz Mohammed Salem Al-Amiri", password: "349282", role: "employee" },
    "19870": { name: "Turki Grimel Ali Al-Harbi", password: "824531", role: "employee" },
    "19871": { name: "Abdulrahman Faisal Namaa Al-Amiri", password: "795217", role: "employee" },
    "19873": { name: "Abdullah Ibrahim Rashid Bin Kuwaybin", password: "472666", role: "employee" },
    "19874": { name: "Fahd Saud Ibrahim Al-Otaibi", password: "175074", role: "employee" },
    "19876": { name: "Faisal Awad Eid Al-Amiri", password: "261933", role: "employee" },
    "19878": { name: "Jumaan Ayed Jumaan Al-Qahtani", password: "783504", role: "employee" },
    "19879": { name: "Abdulrahman Mohammed Al-Jarm", password: "279994", role: "employee" },
    "19880": { name: "Saad Misfer Mohammed Al-Dosari", password: "636523", role: "employee" },
    "19882": { name: "Saud Ali Mufreh Al-Qahtani", password: "586251", role: "employee" },
    "19883": { name: "ibrahim abdullah Dhafer Alharthi", password: "123634", role: "employee" },
    "19884": { name: "Mufleh Fahid Mohammed Al-Qahtani", password: "425465", role: "employee" },
    "19886": { name: "Khaled Walid Suleiman Al-Shalil", password: "420408", role: "employee" },
    "20069": { name: "Ahmed Ali Othman Al-Omair", password: "435378", role: "employee" },
    "20092": { name: "Sultan Saeed bin Shaher", password: "862690", role: "employee" },
    "20093": { name: "Mohammed Saad Ali Al-Aklabi", password: "686468", role: "employee" },
    "20094": { name: "Nayef Mishaal Dakhil Allah Al-Mutairi", password: "921581", role: "employee" },
    "20095": { name: "Abdul Latif Faleh Misfer Al-Otaibi", password: "856130", role: "employee" },
    "20097": { name: "Saud Abdullah Saud Al-Saluli", password: "575042", role: "employee" },
    "20101": { name: "Jazea Mubarak Jazea Al-Qahtani", password: "870351", role: "employee" },
    "20172": { name: "Ryan Dhafer Jazea Al-Qahtani", password: "544352", role: "employee" },
    "20173": { name: "Ali Saleh Ali Al-Subaie", password: "124601", role: "employee" },
    "20174": { name: "Salem Ayidh Salem Al-Qahtani", password: "544154", role: "employee" },
    "20175": { name: "Abdullah Mohammed Al-Qweifel Al-Qahtani", password: "767196", role: "employee" },
    "20176": { name: "Faisal Ayidh Rafaan Al-Qahtani", password: "970488", role: "employee" },
    "20363": { name: "Rayan Hamdan Dhafir Al-Harithi", password: "539564", role: "employee" },
    "20650": { name: "Fahad Ahmed Saeed Al-Waqid", password: "501499", role: "employee" },
    "20652": { name: "Hisham Ali Kaabi", password: "497342", role: "employee" },
    "20653": { name: "Khalid Awad Abdullah Al-Ahmari", password: "967277", role: "employee" },
    "20654": { name: "Nasser Dhafer Zayed Al-Bishi", password: "236010", role: "employee" },
    "20655": { name: "Saeed Dokhi Hadhinan Al-Khalidi", password: "512686", role: "employee" },
    "20656": { name: "Salman Majid Salman Al-Omiri", password: "591746", role: "employee" },
    "20659": { name: "Hamad Ahmed Nasser Al-Hassaneh", password: "347839", role: "employee" },
    "20662": { name: "Hussein Abdulaziz Mousa Al-Ghamdi", password: "596310", role: "employee" },
    "20666": { name: "Dhafer Aayed Fahad Al-Arjani", password: "402386", role: "employee" },
    "20668": { name: "Ali bin Mohammed bin Ali Al-Amri", password: "248570", role: "employee" },
    "20669": { name: "Mubarak Ishq Al-Qahs Al-Atifi", password: "724037", role: "employee" },
    "20671": { name: "Sami Muflih Halas Al-Waber Al-Qahtani", password: "545419", role: "employee" },
    "20673": { name: "Mishal Mohammed Shayiq Al-Hawasilah", password: "391419", role: "employee" },
    "20675": { name: "Mohammed Majri Faraj Al-Qahtani", password: "728759", role: "employee" },
    "20677": { name: "Abdulaziz Othman Ayedh Al-Shahrani", password: "479980", role: "employee" },
    "20679": { name: "Saud Ali Mutrek Al-Dosari", password: "635296", role: "employee" },
    "20685": { name: "Hamad Nasser Salem Al-Haydar", password: "284313", role: "employee" },
    "20686": { name: "Nasser Majed Mahdi Al-Subaiyi", password: "147446", role: "employee" },
    "20687": { name: "Yasser Yahya Shuwail", password: "490887", role: "employee" },
    "20690": { name: "Maytham Khalid Mohammed Al-Shammari", password: "489221", role: "employee" },
    "20691": { name: "Majid Abdullah Al-Ghamdi", password: "862052", role: "employee" },
    "20692": { name: "Mohammed Hassan Al-Jizani", password: "259150", role: "employee" },
    "20694": { name: "Fahad Bukhitan Hithal Al-Usaimi", password: "740030", role: "employee" },
    "20695": { name: "Rashid Dhafer Rashid Al-Dosari", password: "841726", role: "employee" },
    "20696": { name: "Abdullah Saad Mutlaq Al-Sumairi", password: "570575", role: "employee" },
    "20697": { name: "Faisal Mohammed Wazn Al-Shahri", password: "213832", role: "employee" },
    "20698": { name: "Nawaf Saeed Faraj Al-Bisher", password: "907638", role: "employee" },
    "20699": { name: "Khalid bin Saad bin Hamdan bin Ali Al-Harbi", password: "851317", role: "employee" },
    "20700": { name: "Mutlaq Abdullah Al-Qahtani", password: "902382", role: "employee" },
    "20701": { name: "Abdulrahman Mohammed bin Ali Al-Omiri", password: "522654", role: "employee" },
    "20702": { name: "Jawid Hassan Jawid Al-Qahtai", password: "604615", role: "employee" },
    "90013": { name: "Omar Hadi Farhan Al-Dawas Al-Qahtani", password: "671858", role: "employee" },
    "20704": { name: "Abdullah Saad Mohsen Al-Shahrani", password: "649616", role: "employee" },
    "20770": { name: "Saleh Saud Musaad Al-Hinini Al-Harbi", password: "517878", role: "employee" },
    "20773": { name: "Abdullah Abdulrahman Mohammed Murair", password: "694971", role: "employee" },
    "20800": { name: "Turki Abdullah Mashbab Al-Ahmari", password: "408332", role: "employee" },
    "20815": { name: "Naif Hadi Salem Al-Muajbah", password: "331894", role: "employee" },
    "20818": { name: "Mohammed Fahd Abdullah Al-Ghasham", password: "184430", role: "employee" },
    "20820": { name: "Mohammed Saad Al-Saad", password: "551742", role: "employee" },
    "20821": { name: "Abdullah Mohammed Khalaf Al-Asimi", password: "909222", role: "employee" },
    "20831": { name: "Abdulaziz Ali Ahmed Al Ghamdi", password: "889646", role: "employee" },
    "20832": { name: "Abdulaziz Yahya Mohammed Madkhali", password: "975144", role: "employee" },
    "21148": { name: "Nawaf Musaed Hamdan Al-Dosari", password: "960602", role: "employee" },
    "21150": { name: "Khalid Hamoud Mohammed Al-Qahtani", password: "201459", role: "employee" },
    "21154": { name: "Abdulmajid Abdulrahman Al-Huwaimil", password: "855979", role: "employee" },
    "21160": { name: "Salman Ayed Al-Saeedan", password: "484721", role: "employee" },
    "21195": { name: "Rashid Ayedh Hassan Al-Qahishi", password: "941580", role: "employee" },
    "21197": { name: "Bassam Masoud Abdullah Al-Masoud", password: "878938", role: "employee" },
    "21208": { name: "Sultan Fahad Al-Enezi", password: "481056", role: "employee" },
    "21210": { name: "Abdullah Ali Hamad Al-Shamlan", password: "785243", role: "employee" },
    "21211": { name: "Abdulrahman Majed Al-Shammari", password: "841591", role: "employee" },
    "21212": { name: "Khalid Mohammed Hadi Al-Mahamid", password: "335246", role: "employee" },
    "21213": { name: "Hamad Ali Mahdi Al-Muhamadi", password: "817804", role: "employee" },
    "21302": { name: "Fayez Awadh Al-Rubaie", password: "675930", role: "employee" },
    "2157": { name: "Ali Hamad Mohammed Al-Zuarr", password: "828439", role: "employee" },
    "2168": { name: "Yahya Musa Zailai Ghunaimi", password: "134470", role: "employee" },
    "3315": { name: "Hamad Abdullah Al-Mutairi", password: "927173", role: "employee" },
    "52748": { name: "Mishari Mohammed Mutlaq Al-Shaibani Al-Otaibi", password: "746114", role: "employee" },
    "5862": { name: "Sultan Khaled Sultan Al Subaie", password: "310538", role: "employee" },
    "6276": { name: "Zaid Saud Nasser Al-Omar", password: "539067", role: "employee" },
    "6913": { name: "Faisal Awad Malfi Al-Anzi", password: "415844", role: "employee" },
    "7134": { name: "Abdullah Mohammed Yahya Sak", password: "947811", role: "employee" },
    "9199": { name: "Ahmed Ibrahim awaji", password: "807897", role: "employee" },
    "9222": { name: "Ali Saeed Alshahrani", password: "303809", role: "employee" },
    "9231": { name: "Abdulaziz Abdullah Alanbar", password: "760921", role: "employee" },
    "9256": { name: "Marzouq Barjas Obaid Al-Dosari", password: "735088", role: "employee" }
};

// Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
const employees = {};
Object.keys(allUsers).forEach(id => {
    employees[id] = allUsers[id].name;
});

const companyList = [
            "ABS",
            "ACES",
            "ACTS",
            "AECOM",
            "AL BAWANI",
            "AL FUWAILEH",
            "AL LAITH",
            "AL LAITH UNITED",
            "AL MAJAL",
            "ALABRAQI",
            "ALAJMI",
            "ALBAWANI",
            "ALFUWAYLIH",
            "ALHAMRA",
            "ALJABER",
            "ALKEFAH",
            "ALMAJAL",
            "ALTAAQA",
            "ALTAMIMI",
            "AMMICO",
            "APPLUS",
            "AQUARABIA",
            "ATKINS",
            "BBI",
            "BUJV",
            "BYRNE",
            "CITY SEC.",
            "CURRIE AND BROWN",
            "DAR ALHANDASAH",
            "DEWAN",
            "DOMOPAN",
            "DR.SULAIMAN HMC",
            "DSA",
            "EGIS",
            "ERGO",
            "ESA SP",
            "ESA WTP",
            "FATHIMA",
            "FEMCO",
            "FILM STUDIO",
            "FIRST C",
            "FMCO",
            "GCC",
            "HAIF",
            "HARBICO",
            "IBJV",
            "IDC",
            "JACOBS",
            "JASASRA",
            "JASH",
            "KTS",
            "LANDLABS",
            "MACE",
            "MAG",
            "MASCO",
            "MCY",
            "METALYAPI",
            "MHT",
            "MOBILY",
            "NABTAT",
            "NESMA & PARTNARS",
            "NESMA - PARTNER, FCC -UP",
            "NESMA JV",
            "NESMA PARTNER UP",
            "NESMA UNITED INDUSTRIES CO. LTD",
            "NEWFAB",
            "OLA HOTEL",
            "ONUR GROUP",
            "PARSONS",
            "PROPETY OWNER",
            "PWC MSI",
            "QIDDIYA EMPLOYEE",
            "QIDDIYA SECURITY",
            "RIYADH EXPRESS",
            "ROAFID ALAMN",
            "SAFARI",
            "SAFCO",
            "SAFE",
            "SAJCO",
            "SALCO",
            "SATCO",
            "SATMNA",
            "SAUDI BAUER",
            "SAUDI LANDSCAPE - SLC",
            "SAUDI SICLI",
            "SFQ BBI",
            "SHAMAL",
            "SIGNWORLD",
            "SISCO",
            "SIX FLAGS",
            "SLC",
            "SNC - TAKEEF (TSJV)",
            "SOG",
            "SSD",
            "SSH",
            "SUPPLIER",
            "SWORD OF GOD",
            "TAJ DHABI",
            "TAKEEF",
            "TAMEAR",
            "TAWAL",
            "TDP",
            "TFD",
            "TSJV TAKEEF",
            "UCC",
            "UNIBETON",
            "UNIMAC"
        ];


const violationCategories = {
            'Ù…Ø±ÙˆØ±ÙŠØ©': ['Ø³Ø±Ø¹Ø©', 'Ø¹ÙƒØ³ Ø³ÙŠØ±', 'Ø¹Ø¯Ù… ØªØ£Ù…ÙŠÙ† Ø­Ù…ÙˆÙ„Ø©', 'ÙˆÙ‚ÙˆÙ Ø®Ø§Ø·Ø¦', 'Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±Ø®ØµØ©', 'Ø­Ù…ÙˆÙ„Ø© Ø²Ø§Ø¦Ø¯Ø©', 'Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø¨ØªÙ‡ÙˆØ±', 'Ø¹Ø¯Ù… Ø±Ø¨Ø· Ø­Ø²Ø§Ù… Ø£Ù…Ø§Ù†', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ§Ù„', 'Ø¹Ø¨ÙˆØ± Ø¯ÙˆØ§Ø± Ø¨Ø·Ø±ÙŠÙ‚Ø© ØºÙŠØ± Ù†Ø¸Ø§Ù…ÙŠØ©', 'Ø³Ø­Ø¨ Ù…Ø±ÙƒØ¨Ø© ØºÙŠØ± Ù†Ø¸Ø§Ù…ÙŠ', 'Ø£Ø®Ø±Ù‰..'],
            'Ø¬Ù†Ø§Ø¦ÙŠØ©': ['ÙˆØ«Ø§Ø¦Ù‚ Ù…Ø²ÙˆØ±Ø©', 'ØªØ®Ø±ÙŠØ¨', 'Ø§Ù†ØªØ­Ø§Ù„ Ø´Ø®ØµÙŠØ©', 'Ø±Ø´ÙˆØ©', 'Ø³Ø±Ù‚Ø©', 'Ø§Ø¹ØªØ¯Ø§Ø¡', 'ØµØ¯Ù… ÙˆÙ‡Ø±ÙˆØ¨', 'Ø£Ø®Ø±Ù‰..'],
            'Ø¹Ø¯Ù…_Ø§Ù„ØªØ²Ø§Ù…': ['Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©', 'Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ¨', 'ÙˆØ±Ø´Ø© ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù‡Ø§', 'ØªÙ†Ù‚Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ø§Ù…', 'Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø´Ø®Ø§Øµ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù‡Ù…', 'Ø¨Ø§Ø¦Ø¹ Ù…ØªØ¬ÙˆÙ„', 'Ø­Ø±Ø§Ø³Ø© Ù…ÙˆÙ‚Ø¹ Ù„ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡', 'ØªØµÙˆÙŠØ± Ø¨Ø¯ÙˆÙ† ØªØµØ±ÙŠØ­', 'Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù†Ø¸Ø§Ù…ÙŠ', 'Ø£Ø®Ø±Ù‰..'],
            'ØªØµØ§Ø±ÙŠØ­': ['Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØµØ±ÙŠØ­', 'Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªÙƒØ±', 'ØªØµØ±ÙŠØ­ Ù…Ù†ØªÙ‡ÙŠ', 'Ù„Ø§ÙŠÙˆØ¬Ø¯ ØªØµØ±ÙŠØ­', 'Ù…Ù†Ø¹ Ø¯Ø®ÙˆÙ„']
        };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let currentLoginType = 'employee';
let violations = [];
let uploadedImages = [];
let currentLocation = null;
let map = null;
let marker = null;
let lastViolation = null;
let companyDropdownOpen = false;
let charts = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveToStorage() {
  localStorage.setItem('violations', JSON.stringify(violations));
  updateBadge();
}
function loadFromStorage() {
  const s = localStorage.getItem('violations');
  if (s) { violations = JSON.parse(s); }
  updateBadge();
}
function updateBadge() {
  document.getElementById('excelBadge').textContent = violations.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = type==='error' ? 'rgba(239,68,68,0.15)' : 'rgba(16,185,129,0.15)';
  t.style.color = type==='error' ? '#f87171' : '#34d399';
  t.style.borderColor = type==='error' ? 'rgba(239,68,68,0.3)' : 'rgba(16,185,129,0.3)';
  t.style.display = 'block';
  setTimeout(() => { t.style.display = 'none'; }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}
function closeSidebar() {
  document.getElementById('sidebar')?.classList.remove('open');
  document.getElementById('sidebarOverlay')?.classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOTTOM NAV (MOBILE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildBottomNav(role) {
  const nav = document.getElementById('mobileBottomNav');
  if (!nav) return;
  const items = (role === 'supervisor' || role === 'admin')
    ? [
        { id:'dashboard', icon:'ğŸ“Š', label:'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
        { id:'pending',   icon:'â³', label:'Ù…Ø±Ø§Ø¬Ø¹Ø©', badge:'pendingCount' },
        { id:'approved',  icon:'âœ…', label:'Ù…ÙˆØ§ÙÙ‚' },
        { id:'myViolations', icon:'ğŸ“‹', label:'Ø§Ù„Ø³Ø¬Ù„' },
        { id:'reports',   icon:'ğŸ“ˆ', label:'ØªÙ‚Ø§Ø±ÙŠØ±' },
      ]
    : [
        { id:'dashboard',    icon:'ğŸ“Š', label:'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
        { id:'form',         icon:'ğŸ“', label:'ØªØ³Ø¬ÙŠÙ„' },
        { id:'myViolations', icon:'ğŸ“‹', label:'Ø§Ù„Ø³Ø¬Ù„' },
      ];

  nav.innerHTML = items.map(item => `
    <button class="bottom-nav-item" id="bn_${item.id}" onclick="showTabMobile('${item.id}')">
      <div class="bottom-nav-wrap">
        <span class="bn-icon">${item.icon}</span>
        ${item.badge ? `<span class="bottom-nav-badge" id="${item.badge}" style="display:none;"></span>` : ''}
      </div>
      <span>${item.label}</span>
    </button>
  `).join('');
}

function showTabMobile(tab) {
  closeSidebar();
  showTab(tab);
  // Update bottom nav active
  document.querySelectorAll('.bottom-nav-item').forEach(btn => btn.classList.remove('active'));
  const active = document.getElementById('bn_'+tab);
  if (active) active.classList.add('active');
}

function updatePendingBadge() {
  const pending = violations.filter(v => v.status === 'pending');
  const badge = document.getElementById('pendingCount');
  if (badge) {
    badge.style.display = pending.length ? 'block' : 'none';
    badge.textContent = pending.length;
  }
}

// Override buildSidebarNav to also build bottom nav
const _origBuildSidebarNav = buildSidebarNav;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchLoginTab(type) {
  currentLoginType = type;
  document.getElementById('empTab').classList.toggle('active', type==='employee');
  document.getElementById('supTab').classList.toggle('active', type==='supervisor');
  const adminTab = document.getElementById('adminTab');
  if (adminTab) adminTab.classList.toggle('active', type==='admin');
  document.getElementById('supervisorCodeField').style.display = type==='supervisor' ? 'block' : 'none';
  // For admin: pre-fill the employee id field hint
  const empIdField = document.getElementById('employeeId');
  if (type === 'admin') {
    empIdField.placeholder = 'ADMIN';
  } else {
    empIdField.placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ';
  }
  if (type==='employee' || type==='admin') document.getElementById('supervisorCode').value = '';
}

function login() {
  const empId = document.getElementById('employeeId').value.trim();
  const password = document.getElementById('userPassword').value.trim();
  const errDiv = document.getElementById('loginError');
  errDiv.style.display = 'none';

  if (!empId || !password) {
    errDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ';
    errDiv.style.display = 'block'; return;
  }
  // Admin direct login
  if (currentLoginType === 'admin') {
    if (empId !== 'ADMIN') {
      errDiv.textContent = 'âŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­ â€” Ø§Ø³ØªØ®Ø¯Ù… ADMIN';
      errDiv.style.display = 'block'; return;
    }
    if (!allUsers['ADMIN'] || allUsers['ADMIN'].password !== password) {
      errDiv.textContent = 'âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
      errDiv.style.display = 'block'; return;
    }
    // Admin logged in
    currentUser = { id: 'ADMIN', name: allUsers['ADMIN'].name, role: 'admin', group: 'admin' };
    document.getElementById('loginPage').classList.add('hide');
    document.getElementById('mainApp').classList.remove('hide');
    document.getElementById('userName').textContent = 'Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…';
    document.getElementById('userRole').textContent = 'ğŸ›¡ï¸ Admin â€” ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©';
    document.getElementById('excelBtn').style.display = 'flex';
    buildSidebarNav('admin');
    showTab('adminPanel');
    loadFromStorage();
    return;
  }
  if (!allUsers[empId]) {
    errDiv.textContent = 'âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
    errDiv.style.display = 'block'; return;
  }
  const user = allUsers[empId];
  if (user.password !== password) {
    errDiv.textContent = 'âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­';
    errDiv.style.display = 'block'; return;
  }

  let finalRole = 'employee';
  let supervisorGroup = null;
  if (currentLoginType === 'supervisor') {
    const supCode = document.getElementById('supervisorCode').value.trim();
    if (!supCode) {
      errDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù';
      errDiv.style.display = 'block'; return;
    }
    if (!SUPERVISOR_CODES[supCode]) {
      errDiv.textContent = 'âŒ Ø±Ù…Ø² Ø§Ù„Ù…Ø´Ø±Ù ØºÙŠØ± ØµØ­ÙŠØ­! ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø²Ùƒ';
      errDiv.style.display = 'block'; return;
    }
    supervisorGroup = SUPERVISOR_CODES[supCode];
    finalRole = supervisorGroup === 'admin' ? 'admin' : 'supervisor';
  }

  currentUser = { id: empId, name: user.name, role: finalRole, group: supervisorGroup };
  document.getElementById('loginPage').classList.add('hide');
  document.getElementById('mainApp').classList.remove('hide');
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userRole').textContent =
    finalRole === 'admin'      ? 'ğŸ›¡ï¸ Ù…Ø±Ø§Ù‚Ø¨ Ø³Ø±ÙŠ â€” Admin' :
    finalRole === 'supervisor' ? 'ğŸ‘” Ù…Ø´Ø±Ù â€” ' + (supervisorGroup || '') :
                                 'ğŸ‘¤ Ù…ÙˆØ¸Ù';

  buildSidebarNav(finalRole);
  if (finalRole === 'supervisor' || finalRole === 'admin') {
    document.getElementById('excelBtn').style.display = 'flex';
    showTab('dashboard');
  } else {
    showTab('form');
  }
  loadFromStorage();
}

function logout() {
  currentUser = null;
  currentLoginType = 'employee';
  document.getElementById('mainApp').classList.add('hide');
  document.getElementById('loginPage').classList.remove('hide');
  document.getElementById('employeeId').value = '';
  document.getElementById('userPassword').value = '';
  document.getElementById('supervisorCode').value = '';
  document.getElementById('supervisorCodeField').style.display = 'none';
  document.getElementById('empTab').classList.add('active');
  document.getElementById('supTab').classList.remove('active');
  const aTab = document.getElementById('adminTab');
  if (aTab) aTab.classList.remove('active');
  document.getElementById('employeeId').placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ';
  document.getElementById('excelBtn').style.display = 'none';
  // destroy charts
  Object.values(charts).forEach(c => c && c.destroy());
  charts = {};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const employeeNavItems = [
  { id:'dashboard', icon:'ğŸ“Š', label:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
  { id:'form', icon:'ğŸ“', label:'ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©' },
  { id:'myViolations', icon:'ğŸ“‹', label:'Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª' },
];
const supervisorNavItems = [
  { id:'dashboard', icon:'ğŸ“Š', label:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
  { id:'reports', icon:'ğŸ“ˆ', label:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠØ©' },
  { id:'pending', icon:'â³', label:'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' },
  { id:'approved', icon:'âœ…', label:'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§' },
  { id:'rejected', icon:'âŒ', label:'Ù…Ø±ÙÙˆØ¶Ø©' },
  { id:'myViolations', icon:'ğŸ“‹', label:'ÙƒÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª' },
  { id:'waSettings', icon:'ğŸ’¬', label:'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' },
];
const adminNavItems = [
  { id:'dashboard', icon:'ğŸ“Š', label:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©' },
  { id:'reports',   icon:'ğŸ“ˆ', label:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠØ©' },
  { id:'pending',   icon:'â³', label:'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' },
  { id:'approved',  icon:'âœ…', label:'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§' },
  { id:'rejected',  icon:'âŒ', label:'Ù…Ø±ÙÙˆØ¶Ø©' },
  { id:'myViolations', icon:'ğŸ“‹', label:'ÙƒÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª' },
  { id:'waSettings',icon:'ğŸ’¬', label:'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' },
  { id:'adminPanel',icon:'ğŸ›¡ï¸', label:'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨' },
];

function buildSidebarNav(role) {
  const items = role === 'admin' ? adminNavItems : role === 'supervisor' ? supervisorNavItems : employeeNavItems;
  const nav = document.getElementById('sidebarNav');
  nav.innerHTML = items.map(item => `
    <div class="nav-item" id="nav_${item.id}" onclick="showTabMobile('${item.id}')">
      <span class="nav-icon" style="font-size:22px;">${item.icon}</span>
      <span>${item.label}</span>
    </div>
  `).join('');
  buildBottomNav(role);
}

function showTab(tab) {
  const tabs = ['dashboard','form','myViolations','pending','approved','rejected','reports','waSettings','adminPanel'];
  tabs.forEach(t => {
    const el = document.getElementById(t+'Tab');
    if (el) el.classList.add('hide');
    const nav = document.getElementById('nav_'+t);
    if (nav) nav.classList.remove('active');
    const bn = document.getElementById('bn_'+t);
    if (bn) bn.classList.remove('active');
  });
  const target = document.getElementById(tab+'Tab');
  if (target) target.classList.remove('hide');
  const navItem = document.getElementById('nav_'+tab);
  if (navItem) navItem.classList.add('active');
  const bnItem = document.getElementById('bn_'+tab);
  if (bnItem) bnItem.classList.add('active');

  if (tab === 'dashboard') renderDashboard();
  else if (tab === 'myViolations') { applyFilters(); }
  else if (tab === 'pending') { renderViolationList('pending', 'pendingList', true); updatePendingBadge(); }
  else if (tab === 'approved') renderViolationList('approved', 'approvedList', false);
  else if (tab === 'rejected') renderViolationList('rejected', 'rejectedList', false);
  else if (tab === 'reports') renderReports('today');
  else if (tab === 'waSettings') loadWASettings();
  else if (tab === 'adminPanel') renderAdminPanel();
  updatePendingBadge();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø´Ø±Ù (Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ±Ù‰ Ø§Ù„ÙƒÙ„)
  let data = violations;
  if (currentUser && currentUser.role === 'supervisor' && currentUser.group) {
    data = data.filter(v => v.receivingGroup === currentUser.group);
  }

  // ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  const typeFilter = document.getElementById('dashFilterType')?.value || '';
  if (typeFilter) {
    data = data.filter(v => v.mainViolationType === typeFilter);
  }

  const total    = data.length;
  const pending  = data.filter(v => v.status==='pending').length;
  const approved = data.filter(v => v.status==='approved').length;
  const rejected = data.filter(v => v.status==='rejected').length;
  const today    = new Date().toLocaleDateString('ar-SA');
  const todayCount = data.filter(v => v.date === today).length;
  const approvalRate = total > 0 ? Math.round((approved / total) * 100) : 0;

  // Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  document.getElementById('statCards').innerHTML = `
    <div class="stat-card gold"><div class="stat-icon">ğŸ“‹</div><div class="stat-value">${total}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</div></div>
    <div class="stat-card amber"><div class="stat-icon">â³</div><div class="stat-value">${pending}</div><div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div></div>
    <div class="stat-card green"><div class="stat-icon">âœ…</div><div class="stat-value">${approved}</div><div class="stat-label">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</div></div>
    <div class="stat-card red"><div class="stat-icon">âŒ</div><div class="stat-value">${rejected}</div><div class="stat-label">Ù…Ø±ÙÙˆØ¶Ø©</div></div>
    <div class="stat-card blue"><div class="stat-icon">ğŸ“…</div><div class="stat-value">${todayCount}</div><div class="stat-label">Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div></div>
    <div class="stat-card" style="--accent:rgba(168,85,247,0.15);border-color:rgba(168,85,247,0.3);"><div class="stat-icon">ğŸ“ˆ</div><div class="stat-value">${approvalRate}%</div><div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</div></div>
  `;

  const chartDefaults = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { labels: { color:'#e2e8f0', font:{ family:'Tajawal', size:11 } } } }
  };
  const barScales = { scales:{ x:{ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'rgba(255,255,255,0.05)'}}, y:{ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'rgba(255,255,255,0.05)'}} } };
  const colors8 = ['rgba(212,175,55,0.8)','rgba(239,68,68,0.8)','rgba(16,185,129,0.8)','rgba(59,130,246,0.8)','rgba(168,85,247,0.8)','rgba(245,158,11,0.8)','rgba(236,72,153,0.8)','rgba(14,165,233,0.8)'];

  // â”€â”€ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (doughnut)
  const byType = {};
  data.forEach(v => { byType[v.mainViolationTypeLabel] = (byType[v.mainViolationTypeLabel]||0)+1; });
  renderChart('chartByType', 'doughnut', Object.keys(byType), Object.values(byType), colors8, chartDefaults);

  // â”€â”€ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ (horizontal bar - Ø£Ø¹Ù„Ù‰ 12)
  const bySubType = {};
  data.forEach(v => { if(v.subViolationType) bySubType[v.subViolationType] = (bySubType[v.subViolationType]||0)+1; });
  const topSub = Object.entries(bySubType).sort((a,b)=>b[1]-a[1]).slice(0,12);
  renderChart('chartBySubType', 'bar', topSub.map(s=>s[0]), topSub.map(s=>s[1]), colors8,
    {...chartDefaults, indexAxis:'y', plugins:{...chartDefaults.plugins, legend:{display:false}}, ...barScales});

  // â”€â”€ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (bar)
  renderChart('chartByStatus', 'bar', ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§','Ù…Ø±ÙÙˆØ¶Ø©'], [pending, approved, rejected],
    ['rgba(245,158,11,0.8)','rgba(16,185,129,0.8)','rgba(239,68,68,0.8)'], {...chartDefaults, ...barScales});

  // â”€â”€ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (bar)
  const byZone = {};
  data.forEach(v => { if(v.zone) byZone[v.zone]=(byZone[v.zone]||0)+1; });
  renderChart('chartByZone', 'bar', Object.keys(byZone), Object.values(byZone), colors8, {...chartDefaults, ...barScales});

  // â”€â”€ Ø­Ø³Ø¨ Ø§Ù„Ø´ÙØª (doughnut)
  const byShift = {};
  data.forEach(v => { if(v.shift) byShift['Shift '+v.shift]=(byShift['Shift '+v.shift]||0)+1; });
  renderChart('chartByShift', 'doughnut', Object.keys(byShift), Object.values(byShift), ['#ffd700','#10b981','#3b82f6'], chartDefaults);

  // â”€â”€ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (bar)
  const byGroup = {};
  data.forEach(v => { if(v.receivingGroup) byGroup[v.receivingGroup]=(byGroup[v.receivingGroup]||0)+1; });
  renderChart('chartByGroup', 'bar', Object.keys(byGroup), Object.values(byGroup), colors8, {...chartDefaults, ...barScales});

  // â”€â”€ Ø£ÙƒØ«Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª (horizontal bar - Ø£Ø¹Ù„Ù‰ 10)
  const coCounts = {};
  data.forEach(v => { if(v.companyName) coCounts[v.companyName]=(coCounts[v.companyName]||0)+1; });
  const topCoChart = Object.entries(coCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  renderChart('chartByCompany', 'bar', topCoChart.map(c=>c[0]), topCoChart.map(c=>c[1]), colors8,
    {...chartDefaults, indexAxis:'y', plugins:{...chartDefaults.plugins, legend:{display:false}}, ...barScales});

  // â”€â”€ Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ (stacked bar - Ø£Ø¹Ù„Ù‰ 8 Ø´Ø±ÙƒØ§Øª)
  const topCoNames = topCoChart.slice(0,8).map(c=>c[0]);
  const typeLabels = [...new Set(data.map(v=>v.mainViolationTypeLabel))];
  const stackedDatasets = typeLabels.map((type, i) => ({
    label: type,
    data: topCoNames.map(co => data.filter(v => v.companyName===co && v.mainViolationTypeLabel===type).length),
    backgroundColor: colors8[i % colors8.length],
    borderRadius: 4,
  }));
  if (charts['chartCompanyByType']) charts['chartCompanyByType'].destroy();
  const ctxCT = document.getElementById('chartCompanyByType')?.getContext('2d');
  if (ctxCT) {
    charts['chartCompanyByType'] = new Chart(ctxCT, {
      type: 'bar',
      data: { labels: topCoNames, datasets: stackedDatasets },
      options: {
        ...chartDefaults, indexAxis:'y',
        plugins: { ...chartDefaults.plugins, legend: { position:'bottom', labels: { color:'#e2e8f0', font:{family:'Tajawal',size:10} } } },
        scales: {
          x: { stacked:true, ticks:{color:'#94a3b8'}, grid:{color:'rgba(255,255,255,0.05)'} },
          y: { stacked:true, ticks:{color:'#94a3b8',font:{size:10}}, grid:{color:'rgba(255,255,255,0.05)'} }
        }
      }
    });
  }

  // â”€â”€ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„Ù…ÙØªØ´ÙŠÙ†
  const topCo = Object.entries(coCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const maxCo = topCo[0]?.[1] || 1;
  document.getElementById('topCompanies').innerHTML = topCo.length
    ? topCo.map(([name,count],i) => `<li><div class="top-rank">${i+1}</div><div class="top-name">${name}</div><div class="top-bar-wrap"><div class="top-bar" style="width:${(count/maxCo)*100}%"></div></div><div class="top-count">${count}</div></li>`).join('')
    : '<li style="color:var(--muted);padding:20px 0;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>';

  const insCounts = {};
  data.forEach(v => { if(v.inspector) insCounts[v.inspector]=(insCounts[v.inspector]||0)+1; });
  const topIns = Object.entries(insCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const maxIns = topIns[0]?.[1] || 1;
  document.getElementById('topInspectors').innerHTML = topIns.length
    ? topIns.map(([name,count],i) => `<li><div class="top-rank">${i+1}</div><div class="top-name">${name}</div><div class="top-bar-wrap"><div class="top-bar" style="width:${(count/maxIns)*100}%"></div></div><div class="top-count">${count}</div></li>`).join('')
    : '<li style="color:var(--muted);padding:20px 0;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</li>';

  // â”€â”€ Ø¬Ø¯ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠ: Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ã— Ø§Ù„ÙØ±Ø¹ÙŠ Ã— Ø§Ù„Ø´Ø±ÙƒØ§Øª
  const typeMap = {};
  data.forEach(v => {
    const main = v.mainViolationTypeLabel || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const sub = v.subViolationType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    if (!typeMap[main]) typeMap[main] = {};
    if (!typeMap[main][sub]) typeMap[main][sub] = { count:0, companies:{} };
    typeMap[main][sub].count++;
    const co = v.companyName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    typeMap[main][sub].companies[co] = (typeMap[main][sub].companies[co]||0) + 1;
  });

  let tableHtml = `<table style="width:100%;border-collapse:collapse;font-size:13px;">
    <thead><tr style="background:rgba(212,175,55,0.15);">
      <th style="padding:12px;border:1px solid rgba(212,175,55,0.2);color:var(--gold);text-align:right;">Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</th>
      <th style="padding:12px;border:1px solid rgba(212,175,55,0.2);color:var(--gold);text-align:right;">Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</th>
      <th style="padding:12px;border:1px solid rgba(212,175,55,0.2);color:var(--gold);text-align:center;">Ø§Ù„Ø¹Ø¯Ø¯</th>
      <th style="padding:12px;border:1px solid rgba(212,175,55,0.2);color:var(--gold);text-align:right;">Ø£ÙƒØ«Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª</th>
    </tr></thead><tbody>`;

  const mainTypes = Object.entries(typeMap).sort((a,b) => {
    const totalA = Object.values(a[1]).reduce((s,v)=>s+v.count,0);
    const totalB = Object.values(b[1]).reduce((s,v)=>s+v.count,0);
    return totalB - totalA;
  });

  mainTypes.forEach(([main, subs]) => {
    const sortedSubs = Object.entries(subs).sort((a,b) => b[1].count - a[1].count);
    const mainTotal = sortedSubs.reduce((s,v) => s+v[1].count, 0);
    sortedSubs.forEach(([sub, info], i) => {
      const topCos = Object.entries(info.companies).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([n,c])=>`${n} (${c})`).join('ØŒ ');
      tableHtml += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);${i===0?'border-top:2px solid rgba(212,175,55,0.3);':''}">
        ${i===0 ? `<td rowspan="${sortedSubs.length}" style="padding:10px;border:1px solid rgba(212,175,55,0.15);font-weight:700;color:var(--gold-light);vertical-align:top;">${main}<br><span style="font-size:11px;color:var(--muted);">(${mainTotal})</span></td>` : ''}
        <td style="padding:10px;border:1px solid rgba(212,175,55,0.1);">${sub}</td>
        <td style="padding:10px;border:1px solid rgba(212,175,55,0.1);text-align:center;font-weight:700;color:var(--gold);">${info.count}</td>
        <td style="padding:10px;border:1px solid rgba(212,175,55,0.1);font-size:12px;color:var(--muted);">${topCos}</td>
      </tr>`;
    });
  });

  tableHtml += '</tbody></table>';
  document.getElementById('subTypeTable').innerHTML = data.length ? tableHtml : '<div style="text-align:center;color:var(--muted);padding:30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
}

function renderChart(id, type, labels, data, colors, opts) {
  if (charts[id]) { charts[id].destroy(); }
  const ctx = document.getElementById(id)?.getContext('2d');
  if (!ctx) return;
  const finalOpts = {...opts};
  if (opts.indexAxis) { finalOpts.indexAxis = opts.indexAxis; }
  charts[id] = new Chart(ctx, {
    type,
    data: {
      labels,
      datasets:[{
        data,
        backgroundColor: colors,
        borderColor: type==='doughnut' ? 'rgba(0,0,0,0.2)' : colors,
        borderWidth: 1, borderRadius: type==='bar' ? 6 : 0,
      }]
    },
    options: finalOpts
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPEAT OFFENDER DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getRepeatInfo(v, excludeSelf = true) {
  const all = excludeSelf ? violations.filter(x => x.refNumber !== v.refNumber) : violations;
  const result = { plate: [], id: [] };
  // ØªØªØ¨Ø¹ Ø§Ù„Ù„ÙˆØ­Ø© ÙˆØ§Ù„Ù‡ÙˆÙŠØ© ÙÙ‚Ø· â€” Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ø³ØªØ«Ù†Ø§Ø©
  if (v.vehiclePlate && v.vehiclePlate.trim()) {
    result.plate = all.filter(x => x.vehiclePlate && x.vehiclePlate.trim().toUpperCase() === v.vehiclePlate.trim().toUpperCase());
  }
  if (v.violatorId && v.violatorId.trim()) {
    result.id = all.filter(x => x.violatorId && x.violatorId.trim() === v.violatorId.trim());
  }
  return result;
}

function repeatWarningHTML(v) {
  const r = getRepeatInfo(v);
  const lines = [];
  if (r.plate.length) {
    const dates = r.plate.map(x=>`${x.date} (${x.mainViolationTypeLabel||x.subViolationType})`).join(' | ');
    lines.push(`<div class="rw-item">ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© <span>${v.vehiclePlate}</span> Ø³ÙØ¬ÙÙ‘Ù„Øª Ù…Ø®Ø§Ù„ÙØ© Ù‚Ø¨Ù„ Ø°Ù„Ùƒ: <span>${r.plate.length}x</span> â€” ${dates}</div>`);
  }
  if (r.id.length) {
    const dates = r.id.map(x=>`${x.date} (${x.mainViolationTypeLabel||x.subViolationType})`).join(' | ');
    lines.push(`<div class="rw-item">ğŸªª Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© <span>${v.violatorId}</span> Ø³ÙØ¬ÙÙ‘Ù„ Ù…Ø®Ø§Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø§Ù‹: <span>${r.id.length}x</span> â€” ${dates}</div>`);
  }

  if (!lines.length) return '';
  return `<div class="repeat-warning"><div class="rw-title">âš ï¸ Ù…Ø®Ø§Ù„Ù Ù…ØªÙƒØ±Ø±!</div>${lines.join('')}</div>`;
}

function repeatBadgesHTML(v) {
  const r = getRepeatInfo(v);
  let html = '';
  if (r.plate.length)   html += `<span class="repeat-badge plate">ğŸš— Ù„ÙˆØ­Ø© Ã—${r.plate.length}</span>`;
  if (r.id.length)      html += `<span class="repeat-badge id">ğŸªª Ù‡ÙˆÙŠØ© Ã—${r.id.length}</span>`;

  return html;
}

// ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function checkRepeatOnForm() {
  const plate = (document.getElementById('vehiclePlate')?.value || '').trim().toUpperCase();
  const id    = (document.getElementById('violatorId')?.value || '').trim();
  const alerts = [];

  if (plate) {
    const m = violations.filter(x => x.vehiclePlate && x.vehiclePlate.trim().toUpperCase() === plate);
    if (m.length) alerts.push(`ğŸš— Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© <b>${plate}</b> Ù…Ø³Ø¬Ù„Ø© ${m.length} Ù…Ø®Ø§Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© â€” Ø¢Ø®Ø±Ù‡Ø§: ${m[m.length-1].date}`);
  }
  if (id) {
    const m = violations.filter(x => x.violatorId && x.violatorId.trim() === id);
    if (m.length) alerts.push(`ğŸªª Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© <b>${id}</b> Ù…Ø³Ø¬Ù„ ${m.length} Ù…Ø®Ø§Ù„ÙØ© Ø³Ø§Ø¨Ù‚Ø© â€” Ø¢Ø®Ø±Ù‡Ø§: ${m[m.length-1].date}`);
  }


  const alertEl = document.getElementById('formRepeatAlert');
  if (!alertEl) return;
  if (alerts.length) {
    alertEl.innerHTML = 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø®Ø§Ù„Ù Ù…ØªÙƒØ±Ø±!<br>' + alerts.join('<br>');
    alertEl.style.display = 'block';
  } else {
    alertEl.style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIOLATION CARD RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderViolationList(status, containerId, canReview) {
  let filtered = status ? violations.filter(v=>v.status===status) : violations;
  // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø´Ø±Ù (Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ±Ù‰ Ø§Ù„ÙƒÙ„)
  if (currentUser && currentUser.role === 'supervisor' && currentUser.group) {
    filtered = filtered.filter(v => v.receivingGroup === currentUser.group);
  }
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©/Ø§Ù„Ø±ÙØ¶
  canReview = canReview && currentUser && (currentUser.role === 'supervisor' || currentUser.role === 'admin');
  renderCards(filtered, containerId, canReview);
}

function renderCards(list, containerId, canReview) {
  const div = document.getElementById(containerId);
  if (!list.length) {
    div.innerHTML = '<div style="text-align:center;color:var(--muted);padding:48px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª</div>';
    return;
  }
  div.innerHTML = list.map(v => {
    const statusClass = v.status==='approved'?'approved':v.status==='rejected'?'rejected':'pending';
    const statusText  = v.status==='approved'?'âœ… Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§':v.status==='rejected'?'âŒ Ù…Ø±ÙÙˆØ¶Ø©':'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
    const mapsLink    = v.location ? `https://www.google.com/maps?q=${v.location.lat},${v.location.lng}` : null;
    const repeatBadges = repeatBadgesHTML(v);
    const repeatWarn   = repeatWarningHTML(v);
    return `
    <div class="v-card" ${repeatBadges ? 'style="border-color:rgba(239,68,68,0.4);"' : ''}>
      <div class="v-card-header">
        <div class="v-ref">${v.refNumber}${repeatBadges ? `<span style="margin-right:8px;">${repeatBadges}</span>` : ''}</div>
        <div class="v-status ${statusClass}">${statusText}</div>
      </div>
      ${repeatWarn}
      <div class="v-details">
        <div class="v-detail"><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</strong>${v.mainViolationTypeLabel}</div>
        <div class="v-detail"><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„</strong>${v.subViolationType}</div>
        <div class="v-detail"><strong>Ø§Ù„Ø´Ø±ÙƒØ©</strong>${v.companyName}</div>
        <div class="v-detail"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</strong>${v.zone}</div>
        <div class="v-detail"><strong>Ø§Ù„Ø´ÙØª</strong>${v.shift} | ${v.violationTime}</div>
        <div class="v-detail"><strong>Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­</strong>${v.permitType}</div>
        <div class="v-detail"><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</strong>${v.violatorId}</div>
        <div class="v-detail"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</strong>${v.violatorPhone}</div>
        ${v.vehiclePlate ? `<div class="v-detail"><strong>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</strong>${v.vehiclePlate}</div>` : ''}
        ${v.personCount  ? `<div class="v-detail"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</strong>${v.personCount}</div>` : ''}
        ${v.receivingGroup ? `<div class="v-detail"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</strong>${v.receivingGroup}</div>` : ''}
        <div class="v-detail"><strong>Ø§Ù„Ù…ÙØªØ´</strong>${v.inspector} (${v.inspectorId})</div>
        <div class="v-detail"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</strong>${v.date} â€” ${v.time}</div>
        ${mapsLink ? `<div class="v-detail" style="grid-column:1/-1;"><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹</strong><a href="${mapsLink}" target="_blank" style="color:#34d399;">ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></div>` : ''}
        ${v.reviewedBy ? `<div class="v-detail"><strong>Ø§Ù„Ù…Ø´Ø±Ù</strong>${v.reviewedBy}</div><div class="v-detail"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</strong>${v.reviewDate}</div>` : ''}
        ${v.reviewNotes ? `<div class="v-detail" style="grid-column:1/-1;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù</strong>${v.reviewNotes}</div>` : ''}
      </div>
      <div class="v-actions">
        <button class="btn-sm btn-pdf" onclick="sharePDFByIndex('${v.refNumber}')">ğŸ“„ PDF</button>
        ${canReview ? `
          <input type="text" class="v-notes-input" data-ref="${v.refNumber}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŒ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù„Ø±ÙØ¶)..." style="flex:1;">
          <button class="btn-sm btn-approve" onclick="approveViolation(this)" data-ref="${v.refNumber}">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
          <button class="btn-sm btn-reject"  onclick="rejectViolation(this)"  data-ref="${v.refNumber}">âŒ Ø±ÙØ¶</button>
        ` : ''}
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADVANCED FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFilters() {
  const q      = (document.getElementById('searchInput')?.value || '').toLowerCase();
  const status = document.getElementById('filterStatus')?.value || '';
  const zone   = document.getElementById('filterZone')?.value || '';
  const shift  = document.getElementById('filterShift')?.value || '';
  const group  = document.getElementById('filterGroup')?.value || '';
  const type   = document.getElementById('filterType')?.value || '';

  let list = violations;
  if (currentUser?.role === 'supervisor' && currentUser.group) {
    list = list.filter(v => v.receivingGroup === currentUser.group);
  }
  if (q)      list = list.filter(v =>
    v.refNumber.toLowerCase().includes(q) ||
    v.violatorId.includes(q) ||
    v.violatorPhone.includes(q) ||
    (v.companyName||'').toLowerCase().includes(q) ||
    (v.inspector||'').toLowerCase().includes(q) ||
    (v.subViolationType||'').toLowerCase().includes(q));
  if (status) list = list.filter(v => v.status === status);
  if (zone)   list = list.filter(v => v.zone === zone);
  if (shift)  list = list.filter(v => v.shift === shift);
  if (group)  list = list.filter(v => v.receivingGroup === group);
  if (type)   list = list.filter(v => v.mainViolationType === type);

  const countEl = document.getElementById('filterCount');
  if (countEl) countEl.textContent = `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: ${list.length} Ù…Ø®Ø§Ù„ÙØ©`;
  renderCards(list, 'violationsList', false);
}

function resetFilters() {
  ['searchInput','filterStatus','filterZone','filterShift','filterGroup','filterType']
    .forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
  applyFilters();
}

// Keep old name for compatibility
function searchViolations() { applyFilters(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHATSAPP NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveWASettings() {
  const enabled = document.getElementById('waEnabled')?.checked || false;
  const template = document.getElementById('waTemplate')?.value || '';
  const nums = [];
  document.querySelectorAll('.wa-number-input').forEach(el => {
    if (el.value.trim()) nums.push(el.value.trim());
  });
  localStorage.setItem('waSettings', JSON.stringify({ enabled, template, nums }));
  showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨');
}

function loadWASettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('waSettings') || '{}');
    if (document.getElementById('waEnabled')) document.getElementById('waEnabled').checked = saved.enabled || false;
    if (saved.template && document.getElementById('waTemplate')) document.getElementById('waTemplate').value = saved.template;
    if (saved.nums && saved.nums.length) {
      const container = document.getElementById('waNumbers');
      if (container) {
        container.innerHTML = '';
        saved.nums.forEach((num, i) => {
          container.innerHTML += `<div class="wa-number-row" style="margin-bottom:8px;">
            <input class="form-input wa-number-input" type="tel" value="${num}" id="waNum${i}" onchange="saveWASettings()">
            <button class="btn-sm btn-pdf" onclick="removeWANumber(${i})">ğŸ—‘ï¸</button>
          </div>`;
        });
      }
    }
  } catch(e) {}
}

function addWANumber() {
  const container = document.getElementById('waNumbers');
  const count = container.querySelectorAll('.wa-number-row').length;
  container.innerHTML += `<div class="wa-number-row" style="margin-bottom:8px;">
    <input class="form-input wa-number-input" type="tel" placeholder="966xxxxxxxxx" id="waNum${count}" onchange="saveWASettings()">
    <button class="btn-sm btn-pdf" onclick="removeWANumber(${count})">ğŸ—‘ï¸</button>
  </div>`;
}

function removeWANumber(idx) {
  const rows = document.querySelectorAll('#waNumbers .wa-number-row');
  if (rows[idx]) rows[idx].remove();
  saveWASettings();
}

function testWANotification() {
  const fakeViolation = {
    refNumber:'QID-TEST-001', mainViolationTypeLabel:'Ù…Ø®Ø§Ù„ÙØ© Ù…Ø±ÙˆØ±ÙŠØ©',
    subViolationType:'ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø±Ø¹Ø©', companyName:'Ø´Ø±ÙƒØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
    zone:'Upper Zone', inspector: currentUser?.name || 'Ù…ÙØªØ´',
    date: new Date().toLocaleDateString('ar-SA'), time: new Date().toLocaleTimeString('ar-SA')
  };
  sendWANotification(fakeViolation);
}

function sendWANotification(violation) {
  try {
    const settings = JSON.parse(localStorage.getItem('waSettings') || '{}');
    if (!settings.enabled || !settings.nums?.length) return;
    const template = settings.template ||
`âš ï¸ Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø© â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠØ©
Ø§Ù„Ø±Ù‚Ù…: {refNumber}
Ø§Ù„Ù†ÙˆØ¹: {type}
Ø§Ù„Ø´Ø±ÙƒØ©: {company}
Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: {zone}
Ø§Ù„Ù…ÙØªØ´: {inspector}
Ø§Ù„ÙˆÙ‚Øª: {time}`;
    const msg = template
      .replace('{refNumber}', violation.refNumber)
      .replace('{type}', violation.mainViolationTypeLabel || violation.subViolationType)
      .replace('{company}', violation.companyName)
      .replace('{zone}', violation.zone)
      .replace('{inspector}', violation.inspector)
      .replace('{time}', violation.date + ' ' + violation.time);

    // Open first number in WhatsApp
    const num = settings.nums[0].replace(/\D/g,'');
    const url = `https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');

    // If multiple numbers, notify user
    if (settings.nums.length > 1) {
      showToast(`ğŸ’¬ ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆÙ„ â€” Ø£Ø±Ù‚Ø§Ù… Ø£Ø®Ø±Ù‰: ${settings.nums.length - 1}`);
    }
  } catch(e) { console.error('WA error:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentReportPeriod = 'today';

function setReportPeriod(period) {
  currentReportPeriod = period;
  ['today','week','month','all'].forEach(p => {
    const btn = document.getElementById('period'+p.charAt(0).toUpperCase()+p.slice(1));
    if (btn) btn.classList.toggle('active', p === period);
  });
  renderReports(period);
}

function getReportData(period) {
  const now = new Date();
  let list = [...violations];
  if (currentUser?.role === 'supervisor' && currentUser.group) {
    list = list.filter(v => v.receivingGroup === currentUser.group);
  }
  if (period === 'today') {
    const today = now.toLocaleDateString('ar-SA');
    list = list.filter(v => v.date === today);
  } else if (period === 'week') {
    const weekAgo = new Date(now - 7*24*60*60*1000);
    list = list.filter(v => {
      try { return new Date(v.date.split('/').reverse().join('-')) >= weekAgo; } catch(e) { return true; }
    });
  } else if (period === 'month') {
    const monthAgo = new Date(now - 30*24*60*60*1000);
    list = list.filter(v => {
      try { return new Date(v.date.split('/').reverse().join('-')) >= monthAgo; } catch(e) { return true; }
    });
  }
  return list;
}

function renderReports(period) {
  const data = getReportData(period);
  const approved = data.filter(v=>v.status==='approved').length;
  const rejected = data.filter(v=>v.status==='rejected').length;
  const pending  = data.filter(v=>v.status==='pending').length;

  const periodLabel = {today:'Ø§Ù„ÙŠÙˆÙ…', week:'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', month:'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±', all:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'}[period];

  // KPIs
  document.getElementById('reportKPIs').innerHTML = `
    <div class="report-stat"><div class="report-stat-num" style="color:var(--gold-light);">${data.length}</div><div class="report-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª â€” ${periodLabel}</div></div>
    <div class="report-stat"><div class="report-stat-num" style="color:#34d399;">${approved}</div><div class="report-stat-label">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</div></div>
    <div class="report-stat"><div class="report-stat-num" style="color:#f87171;">${rejected}</div><div class="report-stat-label">Ù…Ø±ÙÙˆØ¶Ø©</div></div>
    <div class="report-stat"><div class="report-stat-num" style="color:#fbbf24;">${pending}</div><div class="report-stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div></div>
  `;

  // Helper: count by field
  function countBy(field) {
    const map = {};
    data.forEach(v => { const k = v[field]||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; map[k]=(map[k]||0)+1; });
    return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
  }

  function buildTable(entries, label) {
    if (!entries.length) return '<div style="color:var(--muted);padding:20px;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
    const max = entries[0][1];
    return `<table class="report-table">
      <thead><tr><th>${label}</th><th style="text-align:center;">Ø§Ù„Ø¹Ø¯Ø¯</th><th style="text-align:center;">Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr></thead>
      <tbody>${entries.map(([k,v])=>`
        <tr>
          <td>${k}</td>
          <td style="text-align:center;font-weight:700;color:var(--gold);">${v}</td>
          <td style="text-align:center;">
            <div style="display:flex;align-items:center;gap:8px;justify-content:center;">
              <div style="width:60px;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;">
                <div style="width:${Math.round(v/max*100)}%;height:100%;background:var(--gold);border-radius:3px;"></div>
              </div>
              <span style="font-size:11px;color:var(--muted);">${data.length?Math.round(v/data.length*100):0}%</span>
            </div>
          </td>
        </tr>`).join('')}
      </tbody>
    </table>`;
  }

  document.getElementById('reportInspectors').innerHTML = buildTable(countBy('inspector'), 'Ø§Ù„Ù…ÙØªØ´');
  document.getElementById('reportCompanies').innerHTML  = buildTable(countBy('companyName'), 'Ø§Ù„Ø´Ø±ÙƒØ©');
  document.getElementById('reportZones').innerHTML      = buildTable(countBy('zone'), 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©');
  document.getElementById('reportTypes').innerHTML      = buildTable(countBy('mainViolationTypeLabel'), 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©');
}

async function downloadReport() {
  const period = currentReportPeriod;
  const data = getReportData(period);
  const periodLabel = {today:'Ø§Ù„ÙŠÙˆÙ…', week:'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', month:'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±', all:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'}[period];

  function countBy(field) {
    const map = {};
    data.forEach(v => { const k = v[field]||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; map[k]=(map[k]||0)+1; });
    return Object.entries(map).sort((a,b)=>b[1]-a[1]);
  }

  const el = document.createElement('div');
  el.style.cssText='position:fixed;left:-9999px;top:0;width:794px;padding:40px;background:#060d1a;font-family:Arial,sans-serif;color:#e2e8f0;direction:rtl;';
  el.innerHTML=`
    <div style="border:2px solid #d4af37;border-radius:16px;padding:30px;">
      <div style="text-align:center;margin-bottom:24px;">
        <div style="font-size:36px;">ğŸ“ˆ</div>
        <div style="font-size:24px;font-weight:900;color:#ffd700;">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ â€” ${periodLabel}</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-top:4px;">${new Date().toLocaleDateString('ar-SA')} â€” Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠØ©</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:24px;">
        ${[
          ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', data.length, '#ffd700'],
          ['Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§', data.filter(v=>v.status==='approved').length, '#34d399'],
          ['Ù…Ø±ÙÙˆØ¶Ø©', data.filter(v=>v.status==='rejected').length, '#f87171'],
          ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', data.filter(v=>v.status==='pending').length, '#fbbf24'],
        ].map(([l,n,c])=>`<div style="background:rgba(255,255,255,0.05);border:1px solid rgba(212,175,55,0.2);border-radius:10px;padding:16px;text-align:center;">
          <div style="font-size:28px;font-weight:900;color:${c};">${n}</div>
          <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px;">${l}</div>
        </div>`).join('')}
      </div>
      ${[
        ['ğŸ‘® Ø£Ù†Ø´Ø· Ø§Ù„Ù…ÙØªØ´ÙŠÙ†', countBy('inspector')],
        ['ğŸ¢ Ø£ÙƒØ«Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª', countBy('companyName')],
        ['ğŸ“ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚', countBy('zone')],
        ['âš ï¸ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª', countBy('mainViolationTypeLabel')],
      ].map(([title, rows])=>`
        <div style="margin-bottom:16px;">
          <div style="font-size:14px;font-weight:700;color:#d4af37;margin-bottom:8px;">${title}</div>
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead><tr style="background:rgba(212,175,55,0.1);">
              <th style="padding:8px;border:1px solid rgba(212,175,55,0.2);color:#d4af37;text-align:right;">Ø§Ù„Ø§Ø³Ù…</th>
              <th style="padding:8px;border:1px solid rgba(212,175,55,0.2);color:#d4af37;text-align:center;">Ø§Ù„Ø¹Ø¯Ø¯</th>
            </tr></thead>
            <tbody>${rows.slice(0,8).map(([k,v])=>`
              <tr><td style="padding:8px;border:1px solid rgba(255,255,255,0.05);">${k}</td>
              <td style="padding:8px;border:1px solid rgba(255,255,255,0.05);text-align:center;font-weight:700;color:#ffd700;">${v}</td></tr>
            `).join('')}</tbody>
          </table>
        </div>`).join('')}
    </div>`;

  document.body.appendChild(el);
  try {
    const canvas = await html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#060d1a',logging:false});
    const {jsPDF} = window.jspdf;
    const imgData = canvas.toDataURL('image/png');
    const iw=210, ih=(canvas.height*iw)/canvas.width;
    const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    if(ih<=297){doc.addImage(imgData,'PNG',0,0,iw,ih);}
    else{let y=0,rem=ih;while(rem>0){doc.addImage(imgData,'PNG',0,-y,iw,ih);rem-=297;y+=297;if(rem>0)doc.addPage();}}
    doc.save(`ØªÙ‚Ø±ÙŠØ±_${periodLabel}_${new Date().toISOString().split('T')[0]}.pdf`);
    showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
  } catch(err) {
    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±','error');
  } finally {
    document.body.removeChild(el);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPROVE / REJECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function approveViolation(btn) {
  try {
    if (!currentUser || currentUser.role !== 'supervisor') {
      showToast('âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©','error'); return;
    }
    const ref = btn.getAttribute('data-ref');
    const idx = violations.findIndex(x => x.refNumber === ref);
    if (idx === -1) { showToast('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©','error'); return; }
    const notesEl = btn.closest('.v-card').querySelector('.v-notes-input');
    const notes = notesEl ? notesEl.value.trim() : '';
    violations[idx].status = 'approved';
    violations[idx].reviewedBy = currentUser.name;
    violations[idx].reviewerId = currentUser.id;
    violations[idx].reviewDate = new Date().toLocaleDateString('ar-SA');
    violations[idx].reviewTime = new Date().toLocaleTimeString('ar-SA');
    violations[idx].reviewNotes = notes || null;
    saveToStorage();
    sendToGoogleSheets(violations[idx]);
    showToast('âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¥Ù„Ù‰ Google Sheets');
    renderViolationList('pending','pendingList',true);
    renderViolationList('approved','approvedList',false);
    if (typeof renderDashboard === 'function') renderDashboard();
  } catch(e) { console.error(e); showToast('âŒ Ø®Ø·Ø£: '+e.message,'error'); }
}

function rejectViolation(btn) {
  try {
    if (!currentUser || currentUser.role !== 'supervisor') {
      showToast('âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„Ø±ÙØ¶','error'); return;
    }
    const ref = btn.getAttribute('data-ref');
    const idx = violations.findIndex(x => x.refNumber === ref);
    if (idx === -1) { showToast('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©','error'); return; }
    const notesEl = btn.closest('.v-card').querySelector('.v-notes-input');
    const notes = notesEl ? notesEl.value.trim() : '';
    if (!notes) { showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙˆØ¶Ø­ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶','error'); return; }
    violations[idx].status = 'rejected';
    violations[idx].reviewedBy = currentUser.name;
    violations[idx].reviewerId = currentUser.id;
    violations[idx].reviewDate = new Date().toLocaleDateString('ar-SA');
    violations[idx].reviewTime = new Date().toLocaleTimeString('ar-SA');
    violations[idx].reviewNotes = notes;
    saveToStorage();
    showToast('âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©');
    renderViolationList('pending','pendingList',true);
    renderViolationList('rejected','rejectedList',false);
    if (typeof renderDashboard === 'function') renderDashboard();
  } catch(e) { console.error(e); showToast('âŒ Ø®Ø·Ø£: '+e.message,'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function submitViolation() {
  const mainViolationType = document.getElementById('mainViolationType').value;
  let subViolationType    = document.getElementById('subViolationType').value;
  const otherDetail  = document.getElementById('otherViolationDetail').value;
  const personCount  = document.getElementById('personCount').value;
  const permitType   = document.getElementById('permitType').value;
  const zone         = document.getElementById('zone').value;
  const receivingGroup = document.getElementById('receivingGroup').value;
  const shift        = document.getElementById('shift').value;
  const companyName  = document.getElementById('companyName').value;
  const violatorId   = document.getElementById('violatorId').value.trim();
  const violatorPhone= document.getElementById('violatorPhone').value.trim();
  const plateLetters = document.getElementById('plateLetters').value.trim();
  const plateNumbers = document.getElementById('plateNumbers').value.trim();

  if (!mainViolationType||!subViolationType||!permitType||!zone||!receivingGroup||!shift||!companyName||!violatorId||!violatorPhone) {
    showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (*)','error'); return;
  }
  if (!plateLetters||!plateNumbers) {
    showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø­Ø±ÙˆÙ ÙˆØ£Ø±Ù‚Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©','error'); return;
  }
  if (!/^[A-Z]{1,4}$/.test(plateLetters)) {
    showToast('âš ï¸ Ø­Ø±ÙˆÙ Ø§Ù„Ù„ÙˆØ­Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·','error'); return;
  }
  if (subViolationType==='Ø£Ø®Ø±Ù‰..'&&!otherDetail.trim()) {
    showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø£Ø®Ø±Ù‰','error'); return;
  }
  if (mainViolationType==='ØªØµØ§Ø±ÙŠØ­'&&subViolationType!=='Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªÙƒØ±'&&(!personCount||personCount<1)) {
    showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ','error'); return;
  }
  if (!/^[12]\d{9}$/.test(violatorId)) {
    showToast('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 1 Ø£Ùˆ 2 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…','error'); return;
  }
  if (!/^05\d{8}$/.test(violatorPhone)) {
    showToast('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…','error'); return;
  }
  if (!uploadedImages.length) {
    const a = document.getElementById('imgRequiredAlert');
    if (a) a.style.display = 'block';
    showToast('âš ï¸ ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø®Ø§Ù„ÙØ©','error');
    document.getElementById('uploadBtn')?.scrollIntoView({behavior:'smooth', block:'center'});
    return;
  }
  const imgAlert = document.getElementById('imgRequiredAlert');
  if (imgAlert) imgAlert.style.display = 'none';

  const finalSubType = subViolationType==='Ø£Ø®Ø±Ù‰..' ? otherDetail : subViolationType;
  const refNumber = 'QID-'+new Date().getFullYear()+'-'+Date.now().toString().slice(-6);
  const labels = { 'Ù…Ø±ÙˆØ±ÙŠØ©':'Ù…Ø®Ø§Ù„ÙØ© Ù…Ø±ÙˆØ±ÙŠØ©','Ø¬Ù†Ø§Ø¦ÙŠØ©':'Ù…Ø®Ø§Ù„ÙØ© Ø¬Ù†Ø§Ø¦ÙŠØ©','Ø¹Ø¯Ù…_Ø§Ù„ØªØ²Ø§Ù…':'Ø¹Ø¯Ù… Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠØ©','ØªØµØ§Ø±ÙŠØ­':'Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„ØªØµØ§Ø±ÙŠØ­' };

  const violation = {
    refNumber, mainViolationType, mainViolationTypeLabel:labels[mainViolationType]||mainViolationType,
    subViolationType:finalSubType, personCount:personCount||null,
    permitType, zone, receivingGroup, shift,
    violationTime: new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'}),
    companyName, violatorId, violatorPhone,
    vehiclePlate: plateLetters+'-'+plateNumbers,
    location:currentLocation,
    inspector:currentUser.name, inspectorId:currentUser.id,
    date:new Date().toLocaleDateString('ar-SA'),
    time:new Date().toLocaleTimeString('ar-SA'),
    images:[...uploadedImages],
    status:'pending', reviewedBy:null, reviewerId:null,
    reviewDate:null, reviewTime:null, reviewNotes:null
  };

  violations.push(violation);
  saveToStorage();
  lastViolation = violation;

  // Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨
  sendWANotification(violation);

  // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Google Sheets Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  sendToGoogleSheets(violation);

  document.getElementById('refNumber').textContent = refNumber;
  document.getElementById('successMsg').style.display = 'block';
  showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­!');

  // Reset form
  document.getElementById('mainViolationType').value='';
  updateSubViolations();
  ['permitType','zone','receivingGroup','shift'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('companyName').value='';
  document.getElementById('companyDisplayText').textContent='â€” Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© â€”';
  document.getElementById('companyDisplayText').style.color='var(--muted)';
  document.getElementById('violatorId').value='';
  document.getElementById('violatorPhone').value='';
  document.getElementById('plateLetters').value='';
  document.getElementById('plateNumbers').value='';
  document.getElementById('vehiclePlate').value='';
  document.getElementById('platePreview').style.display='none';
  document.getElementById('map').style.display='none';
  document.getElementById('imagePreview').innerHTML='';
  document.getElementById('violationImages').value='';
  const imgAlert2 = document.getElementById('imgRequiredAlert');
  if (imgAlert2) imgAlert2.style.display = 'none';
  document.getElementById('coordinatesDisplay').style.display='none';
  currentLocation=null; uploadedImages=[];
  if(marker&&map){map.removeLayer(marker);marker=null;}
  setTimeout(()=>{ document.getElementById('successMsg').style.display='none'; },5000);
  window.scrollTo(0,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSubViolations() {
  const main = document.getElementById('mainViolationType').value;
  const sub  = document.getElementById('subViolationType');
  sub.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© â€”</option>';
  document.getElementById('otherViolationField').style.display='none';
  document.getElementById('personCountField').style.display='none';
  if (main && violationCategories[main]) {
    sub.disabled = false;
    violationCategories[main].forEach(v => {
      const o=document.createElement('option'); o.value=v; o.textContent=v; sub.appendChild(o);
    });
  } else { sub.disabled=true; }
}

function toggleOtherField() {
  const main=document.getElementById('mainViolationType').value;
  const sub =document.getElementById('subViolationType').value;
  document.getElementById('otherViolationField').style.display = sub==='Ø£Ø®Ø±Ù‰..' ? 'block':'none';
  if (sub!=='Ø£Ø®Ø±Ù‰..') document.getElementById('otherViolationDetail').value='';
  document.getElementById('personCountField').style.display =
    (main==='ØªØµØ§Ø±ÙŠØ­'&&sub&&sub!=='Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªÙƒØ±') ? 'block':'none';
  if(!(main==='ØªØµØ§Ø±ÙŠØ­'&&sub&&sub!=='Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªÙƒØ±')) document.getElementById('personCount').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPANY DROPDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCompanyList(filter) {
  const filtered = filter
    ? companyList.filter(c=>c.toLowerCase().includes(filter.toLowerCase()))
    : companyList;
  const current = document.getElementById('companyName').value;
  const div = document.getElementById('companyList');
  div.innerHTML = filtered.length
    ? filtered.map(c=>`<div class="company-option${c===current?' selected':''}" onclick="selectCompany('${c.replace(/'/g,"\'")}')"> ${c}</div>`).join('')
    : '<div style="color:var(--muted);text-align:center;padding:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
}
function toggleCompanyDropdown() {
  companyDropdownOpen=!companyDropdownOpen;
  const dd=document.getElementById('companyDropdown');
  const tr=document.getElementById('companyTrigger');
  dd.style.display=companyDropdownOpen?'block':'none';
  tr.classList.toggle('open',companyDropdownOpen);
  if(companyDropdownOpen){
    document.getElementById('companySearch').value='';
    renderCompanyList('');
    setTimeout(()=>document.getElementById('companySearch').focus(),80);
  }
}
function filterCompanies(){renderCompanyList(document.getElementById('companySearch').value);}
function selectCompany(name){
  document.getElementById('companyName').value=name;
  document.getElementById('companyDisplayText').textContent=name;
  document.getElementById('companyDisplayText').style.color='var(--text)';
  document.getElementById('companyDropdown').style.display='none';
  document.getElementById('companyTrigger').classList.remove('open');
  companyDropdownOpen=false;
  checkRepeatOnForm();
}
document.addEventListener('click',e=>{
  const w=document.getElementById('companyTrigger');
  const dd=document.getElementById('companyDropdown');
  if(w&&dd&&!w.contains(e.target)&&!dd.contains(e.target)){
    dd.style.display='none';
    w.classList.remove('open');
    companyDropdownOpen=false;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePlate(){
  const l=document.getElementById('plateLetters').value.trim();
  const n=document.getElementById('plateNumbers').value.trim();
  document.getElementById('vehiclePlate').value=(l&&n)?l+'-'+n:'';
  const prev=document.getElementById('platePreview');
  if(l||n){prev.style.display='block';prev.textContent=(l&&n)?l+' â€” '+n:(l||n);}
  else{prev.style.display='none';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap(){
  if(!map){
    map=L.map('map').setView([24.532297,46.439718],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
    map.on('click',e=>setLocation(e.latlng.lat,e.latlng.lng));
  }
}
function showMap(){
  const m=document.getElementById('map');
  if(m.style.display==='none'){m.style.display='block';initMap();setTimeout(()=>map.invalidateSize(),100);}
  else{m.style.display='none';}
}
function setLocation(lat,lng){
  currentLocation={lat,lng};
  if(marker)map.removeLayer(marker);
  marker=L.marker([lat,lng]).addTo(map);
  map.setView([lat,lng],15);
  const cd=document.getElementById('coordinatesDisplay');
  cd.style.display='block';
  cd.innerHTML=`<span style="color:#34d399;font-weight:700;">âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><br>
    <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø®Ø±Ø§Ø¦Ø· Google</a>`;
}
function getCurrentLocation(){
  if(!navigator.geolocation){showToast('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹','error');return;}
  const cd=document.getElementById('coordinatesDisplay');
  cd.style.display='block'; cd.innerHTML='<span style="color:var(--gold);">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</span>';
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const{latitude:lat,longitude:lng}=pos.coords;
      const m=document.getElementById('map');
      if(m.style.display==='none'){m.style.display='block';initMap();setTimeout(()=>{map.invalidateSize();setLocation(lat,lng);},300);}
      else setLocation(lat,lng);
    },
    err=>{
      const msgs={1:'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹',2:'ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ÙØ¹Ù‘Ù„ GPS',3:'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹'};
      const msg='âš ï¸ '+(msgs[err.code]||'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
      cd.innerHTML=`<span style="color:#f87171;">${msg}</span>`;
      showToast(msg,'error');
    },
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function compressImage(file){
  return new Promise(res=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const c=document.createElement('canvas');
        let w=img.width,h=img.height;
        const MAX=800;
        if(w>h){if(w>MAX){h*=MAX/w;w=MAX;}}else{if(h>MAX){w*=MAX/h;h=MAX;}}
        c.width=w;c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        res(c.toDataURL('image/jpeg',0.6));
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}
async function handleImageUpload(e){
  if (uploadedImages.length >= 6) {
    showToast('âš ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 6 ØµÙˆØ±','error');
    return;
  }
  const grid=document.getElementById('imagePreview');
  for(const file of e.target.files){
    if(file.type.startsWith('image/')){
      const compressed=await compressImage(file);
      uploadedImages.push(compressed);
      const item=document.createElement('div');
      item.className='img-preview-item';
      item.innerHTML=`<img src="${compressed}"><button class="img-remove" onclick="removeImage(${uploadedImages.length-1})">Ã—</button>`;
      grid.appendChild(item);
    }
  }
}
function removeImage(idx){
  uploadedImages.splice(idx,1);
  const grid=document.getElementById('imagePreview');
  grid.innerHTML='';
  uploadedImages.forEach((d,i)=>{
    const item=document.createElement('div');
    item.className='img-preview-item';
    item.innerHTML=`<img src="${d}"><button class="img-remove" onclick="removeImage(${i})">Ã—</button>`;
    grid.appendChild(item);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sharePDF(){ if(lastViolation) generatePDF(lastViolation); }
function sharePDFByIndex(ref){
  const v=violations.find(x=>x.refNumber===ref);
  if(v) generatePDF(v);
}

async function generatePDF(violation){
  if(!violation){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ©','error');return;}
  showToast('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF ...');

  const mapsLink = violation.location
    ? `https://www.google.com/maps?q=${violation.location.lat},${violation.location.lng}` : null;
  const statusStyles = {
    approved:'background:#0d3326;border:1px solid #10b981;color:#34d399;',
    rejected :'background:#2d1212;border:1px solid #ef4444;color:#f87171;',
    pending  :'background:#2a1f00;border:1px solid #f59e0b;color:#fbbf24;'
  };
  const statusText = { approved:'âœ“ Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§', rejected:'âœ• Ù…Ø±ÙÙˆØ¶Ø©', pending:'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' };

  // ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø®Ø§Ù„Ù
  const rr = getRepeatInfo(violation);
  const repeatNotes = [];
  if (rr.plate.length)   repeatNotes.push(`Ù„ÙˆØ­Ø© ${violation.vehiclePlate}: ${rr.plate.length} Ù…Ø±Ø©`);
  if (rr.id.length)      repeatNotes.push(`Ù‡ÙˆÙŠØ© ${violation.violatorId}: ${rr.id.length} Ù…Ø±Ø©`);


  // ØµÙˆØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Ø­ØªÙ‰ 4 ØµÙˆØ±)
  const imgs = (violation.images || []).slice(0, 6);

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
  const fields = [
    ['Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©',    violation.mainViolationTypeLabel],
    ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©', violation.subViolationType],
    ['Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­',     violation.permitType],
    ['Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',         violation.zone],
    ['Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©',        violation.receivingGroup||'â€”'],
    ['Ø§Ù„Ø´ÙØª',           violation.shift],
    ['ÙˆÙ‚Øª Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©',    violation.violationTime],
    ['Ø§Ù„Ø´Ø±ÙƒØ©',          violation.companyName],
    ['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©',      violation.violatorId],
    ['Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„',      violation.violatorPhone],
    ['Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©',    violation.vehiclePlate||'â€”'],
    ...(violation.personCount ? [['Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ', violation.personCount]] : []),
    ['Ø§Ù„Ù…ÙØªØ´',          violation.inspector],
    ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ',   violation.inspectorId],
    ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„',   violation.date],
    ['ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„',     violation.time],
  ];

  const el = document.createElement('div');
  // A4 width = 794px at 96dpi. ØªØµÙ…ÙŠÙ… Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶.
  el.style.cssText = [
    'position:fixed','left:-9999px','top:0',
    'width:794px','padding:20px 24px',
    'background:#070e1c',
    'font-family:Arial,Helvetica,sans-serif',
    'color:#dde4f0','direction:rtl',
    'box-sizing:border-box'
  ].join(';');

  el.innerHTML = `
  <div style="border:1.5px solid #d4af37;border-radius:10px;padding:14px;box-sizing:border-box;">

    <!-- â•â•â• HEADER â•â•â• -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;">
      <div>
        <div style="font-size:19px;font-weight:900;color:#ffd700;line-height:1;">ØªÙ‚Ø±ÙŠØ± Ù…Ø®Ø§Ù„ÙØ©</div>
        <div style="font-size:9px;color:rgba(255,255,255,0.4);margin-top:2px;">Violation Report â€” Qiddiya Project</div>
      </div>
      <div style="text-align:center;">
        <div style="background:rgba(212,175,55,0.15);border:1px solid #d4af37;border-radius:6px;padding:5px 16px;display:inline-block;">
          <span style="color:#ffd700;font-size:16px;font-weight:900;letter-spacing:2px;">${violation.refNumber}</span>
        </div>
        <div style="margin-top:4px;">
          <span style="padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700;${statusStyles[violation.status]||statusStyles.pending}">
            ${statusText[violation.status]||statusText.pending}
          </span>
        </div>
      </div>
      <div style="font-size:24px;">âš ï¸</div>
    </div>

    <div style="height:1px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin-bottom:10px;"></div>

    <!-- â•â•â• FIELDS GRID â•â•â• -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px;">
      ${fields.map(([lbl,val])=>`
        <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(212,175,55,0.18);border-radius:6px;padding:6px 8px;">
          <div style="color:#d4af37;font-size:9px;font-weight:700;margin-bottom:2px;">${lbl}</div>
          <div style="color:#fff;font-size:11px;font-weight:600;word-break:break-word;">${val||'â€”'}</div>
        </div>`).join('')}

      ${mapsLink ? `
        <div style="grid-column:1/-1;background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.2);border-radius:6px;padding:5px 7px;">
          <div style="color:#d4af37;font-size:8px;font-weight:700;margin-bottom:1px;">ğŸ“ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
          <div style="color:#34d399;font-size:9px;word-break:break-all;">${mapsLink}</div>
        </div>` : ''}

      ${repeatNotes.length ? `
        <div style="grid-column:1/-1;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.35);border-radius:6px;padding:5px 7px;">
          <div style="color:#f87171;font-size:8px;font-weight:900;margin-bottom:2px;">âš ï¸ Ù…Ø®Ø§Ù„Ù Ù…ØªÙƒØ±Ø±</div>
          <div style="color:#fca5a5;font-size:9px;">${repeatNotes.join(' &nbsp;|&nbsp; ')}</div>
        </div>` : ''}
    </div>

    <!-- â•â•â• ØµÙˆØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© â•â•â• -->
    ${imgs.length ? `
    <div style="margin-bottom:10px;">
      <div style="font-size:9px;font-weight:700;color:#d4af37;margin-bottom:5px;border-right:3px solid #d4af37;padding-right:6px;">ğŸ“¸ ØµÙˆØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (${imgs.length})</div>
      <div style="display:grid;grid-template-columns:${imgs.length===1?'1fr':imgs.length===2?'1fr 1fr':imgs.length<=4?'repeat(4,1fr)':'repeat(3,1fr)'};gap:6px;">
        ${imgs.map((src,i)=>`
          <div style="position:relative;">
            <img src="${src}" style="width:100%;height:${imgs.length===1?'200px':'110px'};object-fit:cover;border-radius:5px;border:1px solid rgba(212,175,55,0.35);display:block;">
            <div style="position:absolute;bottom:2px;right:2px;background:rgba(0,0,0,0.6);color:#d4af37;font-size:8px;padding:1px 5px;border-radius:3px;">ØµÙˆØ±Ø© ${i+1}</div>
          </div>`
        ).join('')}
      </div>
    </div>` : '<div style="margin-bottom:10px;padding:8px;background:rgba(239,68,68,0.08);border:1px dashed rgba(239,68,68,0.3);border-radius:6px;text-align:center;color:#f87171;font-size:9px;">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ ØµÙˆØ± Ù„Ù„Ù…Ø®Ø§Ù„ÙØ©</div>'}

    <!-- â•â•â• Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© â•â•â• -->
    ${violation.reviewedBy ? `
    <div style="background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.25);border-radius:6px;padding:7px 10px;margin-bottom:10px;">
      <div style="color:#86efac;font-weight:700;font-size:10px;margin-bottom:4px;">âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;font-size:9px;">
        <div><span style="color:#d4af37;">Ø§Ù„Ù…Ø´Ø±Ù: </span>${violation.reviewedBy}</div>
        <div><span style="color:#d4af37;">Ø§Ù„Ø±Ù‚Ù…: </span>${violation.reviewerId}</div>
        <div><span style="color:#d4af37;">Ø§Ù„ØªØ§Ø±ÙŠØ®: </span>${violation.reviewDate}</div>
        <div><span style="color:#d4af37;">Ø§Ù„ÙˆÙ‚Øª: </span>${violation.reviewTime}</div>
        ${violation.reviewNotes ? `<div style="grid-column:1/-1;"><span style="color:#d4af37;">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: </span>${violation.reviewNotes}</div>` : ''}
      </div>
    </div>` : ''}

    <!-- â•â•â• Ø¥Ù‚Ø±Ø§Ø± Ø¨ØµØ­Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© â•â•â• -->
    <div style="border:1.5px solid #d4af37;border-radius:8px;padding:10px;background:rgba(212,175,55,0.03);">
      <div style="text-align:center;font-size:12px;font-weight:900;color:#ffd700;margin-bottom:6px;">ğŸ“œ Ø¥Ù‚Ø±Ø§Ø± Ø¨ØµØ­Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</div>
      <div style="font-size:9.5px;color:#cbd5e1;line-height:1.6;margin-bottom:8px;text-align:justify;">
        Ù†ÙÙ‚ÙØ±Ù‘ Ù†Ø­Ù† Ø§Ù„Ù…ÙˆÙ‚Ù‘Ø¹ÙˆÙ† Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø£Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØµØ­ÙŠØ­Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø©ØŒ
        ÙˆØ£Ù† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø±Ù‚Ù… <span style="color:#ffd700;font-weight:700;">${violation.refNumber}</span>
        Ù‚Ø¯ Ø±ÙØµÙØ¯Øª ÙˆØ³ÙØ¬ÙÙ‘Ù„Øª ÙˆÙÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙŠ Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠØ©ØŒ
        ÙˆØ£Ù†Ù†Ø§ Ø¹Ù„Ù‰ Ø¹Ù„Ù… ØªØ§Ù… Ø¨Ù…Ø¶Ù…ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆÙ…Ø§ ÙŠØªØ±ØªØ¨ Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.
      </div>

      <!-- Ø«Ù„Ø§Ø«Ø© ØªÙˆÙ‚ÙŠØ¹Ø§Øª -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">

        <!-- Ø§Ù„Ù…ÙØªØ´ -->
        <div style="border:1px solid rgba(212,175,55,0.4);border-radius:7px;padding:8px;text-align:center;background:rgba(255,255,255,0.02);">
          <div style="font-size:9px;font-weight:700;color:#d4af37;margin-bottom:3px;">ğŸ‘® Ø§Ù„Ù…ÙØªØ´</div>
          <div style="font-size:10px;color:#fff;font-weight:700;margin-bottom:1px;">${violation.inspector||'â€”'}</div>
          <div style="font-size:8.5px;color:rgba(255,255,255,0.45);margin-bottom:3px;">Ø±Ù‚Ù…: ${violation.inspectorId||'â€”'}</div>
          <div style="font-size:8px;color:rgba(255,255,255,0.3);margin-bottom:2px;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${violation.date}</div>
          <div style="border-top:1px dashed rgba(212,175,55,0.4);margin-top:10px;padding-top:5px;">
            <div style="font-size:7.5px;color:rgba(255,255,255,0.3);">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
            <div style="height:22px;border-bottom:1px solid rgba(255,255,255,0.15);margin-top:4px;"></div>
          </div>
        </div>

        <!-- Ø§Ù„Ù…Ø´Ø±Ù -->
        <div style="border:1px solid rgba(212,175,55,0.4);border-radius:7px;padding:8px;text-align:center;background:rgba(255,255,255,0.02);">
          <div style="font-size:9px;font-weight:700;color:#d4af37;margin-bottom:3px;">ğŸ‘” Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
          <div style="font-size:10px;color:#fff;font-weight:700;margin-bottom:1px;">${violation.reviewedBy||'.............................'}</div>
          <div style="font-size:8.5px;color:rgba(255,255,255,0.45);margin-bottom:3px;">Ø±Ù‚Ù…: ${violation.reviewerId||'...............'}</div>
          <div style="font-size:8px;color:rgba(255,255,255,0.3);margin-bottom:2px;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${violation.reviewDate||'.............'}</div>
          <div style="border-top:1px dashed rgba(212,175,55,0.4);margin-top:10px;padding-top:5px;">
            <div style="font-size:7.5px;color:rgba(255,255,255,0.3);">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
            <div style="height:22px;border-bottom:1px solid rgba(255,255,255,0.15);margin-top:4px;"></div>
          </div>
        </div>

        <!-- Ù…Ù…Ø«Ù„ Ø§Ù„Ø´Ø±ÙƒØ© -->
        <div style="border:1px solid rgba(212,175,55,0.4);border-radius:7px;padding:8px;text-align:center;background:rgba(255,255,255,0.02);">
          <div style="font-size:9px;font-weight:700;color:#d4af37;margin-bottom:3px;">ğŸ¢ Ù…Ù…Ø«Ù„ Ø§Ù„Ø´Ø±ÙƒØ©</div>
          <div style="font-size:10px;color:#fff;font-weight:700;margin-bottom:1px;">${violation.companyName||'.............................'}</div>
          <div style="font-size:8.5px;color:rgba(255,255,255,0.45);margin-bottom:3px;">Ø§Ù„Ø§Ø³Ù…: .............................</div>
          <div style="font-size:8px;color:rgba(255,255,255,0.3);margin-bottom:2px;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ...................</div>
          <div style="border-top:1px dashed rgba(212,175,55,0.4);margin-top:10px;padding-top:5px;">
            <div style="font-size:7.5px;color:rgba(255,255,255,0.3);">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
            <div style="height:22px;border-bottom:1px solid rgba(255,255,255,0.15);margin-top:4px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div style="margin-top:8px;text-align:center;color:rgba(255,255,255,0.25);font-size:8px;">
      Ù†Ø¸Ø§Ù… Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠØ© â€” Qiddiya Violations System &nbsp;|&nbsp; Ø·ÙØ¨Ø¹ Ø¨ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}
    </div>
  </div>`;

  document.body.appendChild(el);
  try {
    // Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø¯Ù‚Ø© Ù…Ø¶Ø§Ø¹ÙØ©
    const canvas = await html2canvas(el, {
      scale: 2, useCORS: true, allowTaint: true,
      backgroundColor: '#070e1c', logging: false
    });
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pageW = 210, pageH = 297;
    const margin = 5;
    const usableW = pageW - (margin * 2);
    const usableH = pageH - (margin * 2);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶
    const imgW = canvas.width;
    const imgH = canvas.height;
    const contentH = (imgH / imgW) * usableW;

    if (contentH <= usableH) {
      // Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© - Ø¨Ø¯ÙˆÙ† Ø¶ØºØ·
      doc.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', margin, margin, usableW, contentH);
    } else {
      // Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£Ø·ÙˆÙ„ Ù…Ù† ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© â€” Ù†Ù‚Ø³Ù…Ù‡ Ø¹Ù„Ù‰ Ø¹Ø¯Ø© ØµÙØ­Ø§Øª
      const totalPages = Math.ceil(contentH / usableH);
      for (let page = 0; page < totalPages; page++) {
        if (page > 0) doc.addPage();

        // Ù†Ø­Ø³Ø¨ Ø£ÙŠ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ù†Ù‚Øµ
        const srcY = Math.round((page * usableH / contentH) * imgH);
        const srcH = Math.round((usableH / contentH) * imgH);
        const actualSrcH = Math.min(srcH, imgH - srcY);

        // Ù†Ù†Ø´Ø¦ canvas Ù…Ø¤Ù‚Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = imgW;
        pageCanvas.height = actualSrcH;
        const ctx = pageCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, srcY, imgW, actualSrcH, 0, 0, imgW, actualSrcH);

        const pageContentH = (actualSrcH / imgW) * usableW;
        doc.addImage(pageCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', margin, margin, usableW, pageContentH);
      }
    }

    doc.save(`violation_${violation.refNumber}.pdf`);
    showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ù†Ø¬Ø§Ø­!');
  } catch(err) {
    console.error(err);
    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF','error');
  } finally {
    document.body.removeChild(el);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdminPanel() {
  if (!currentUser || currentUser.role !== 'admin') return;
  const cont = document.getElementById('adminPanelContent');
  if (!cont) return;

  const total    = violations.length;
  const pending  = violations.filter(v=>v.status==='pending').length;
  const approved = violations.filter(v=>v.status==='approved').length;
  const rejected = violations.filter(v=>v.status==='rejected').length;

  // â”€â”€ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒØ±Ø±ÙŠÙ† (Ù„ÙˆØ­Ø© ÙˆÙ‡ÙˆÙŠØ© ÙÙ‚Ø·) â”€â”€
  const plateMap = {}, idMap = {};
  violations.forEach(v => {
    if (v.vehiclePlate) { const k=v.vehiclePlate.trim().toUpperCase(); if(k){ plateMap[k]=(plateMap[k]||[]).concat(v); } }
    if (v.violatorId)   { const k=v.violatorId.trim(); if(k){ idMap[k]=(idMap[k]||[]).concat(v); } }
  });
  const repeatPlates = Object.entries(plateMap).filter(([,arr])=>arr.length>1).sort((a,b)=>b[1].length-a[1].length);
  const repeatIds    = Object.entries(idMap).filter(([,arr])=>arr.length>1).sort((a,b)=>b[1].length-a[1].length);

  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØªØ´ÙŠÙ†
  const inspMap = {};
  violations.forEach(v=>{ inspMap[v.inspector]=(inspMap[v.inspector]||0)+1; });
  const topInsp = Object.entries(inspMap).sort((a,b)=>b[1]-a[1]).slice(0,10);

  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  const groupMap = {};
  violations.forEach(v=>{ const g=v.receivingGroup||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; groupMap[g]=(groupMap[g]||0)+1; });

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†
  const allInspList = Object.entries(allUsers)
    .filter(([id,u])=>u.role==='employee')
    .sort((a,b)=>a[1].name.localeCompare(b[1].name));

  // Ø¢Ø®Ø± 20 Ù…Ø®Ø§Ù„ÙØ©
  const recent = [...violations].sort((a,b)=>new Date(b.date+' '+b.time)-new Date(a.date+' '+a.time)).slice(0,20);

  cont.innerHTML = `
    <!-- KPI Cards -->
    <div class="stats-row" style="margin-bottom:24px;">
      <div class="stat-card gold"><div class="stat-icon">ğŸ“‹</div><div class="stat-value">${total}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</div></div>
      <div class="stat-card amber"><div class="stat-icon">â³</div><div class="stat-value">${pending}</div><div class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div></div>
      <div class="stat-card green"><div class="stat-icon">âœ…</div><div class="stat-value">${approved}</div><div class="stat-label">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§</div></div>
      <div class="stat-card red"><div class="stat-icon">âŒ</div><div class="stat-value">${rejected}</div><div class="stat-label">Ù…Ø±ÙÙˆØ¶Ø©</div></div>
      <div class="stat-card blue"><div class="stat-icon">ğŸ‘®</div><div class="stat-value">${allInspList.length}</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</div></div>
      <div class="stat-card" style="border-color:rgba(239,68,68,0.35);">
        <div class="stat-icon" style="font-size:28px;">ğŸ”</div>
        <div class="stat-value" style="color:#f87171;">${repeatPlates.length + repeatIds.length}</div>
        <div class="stat-label">Ù„ÙˆØ­Ø§Øª ÙˆÙ‡ÙˆÙŠØ§Øª Ù…ØªÙƒØ±Ø±Ø©</div>
      </div>
    </div>

    <!-- â•â•â•â• Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ† Ø§Ù„Ù…ØªÙƒØ±Ø±ÙŠÙ† â•â•â•â• -->
    <div class="card" style="margin-bottom:20px;border-color:rgba(239,68,68,0.4);">
      <div class="card-header" style="background:rgba(239,68,68,0.06);">
        <h3 style="color:#f87171;">ğŸ” Ø§Ù„Ù…Ø®Ø§Ù„ÙÙˆÙ† Ø§Ù„Ù…ØªÙƒØ±Ø±ÙˆÙ†</h3>
      </div>
      <div class="card-body">

        <!-- Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ù‡ÙˆÙŠØ© -->
        <div style="margin-bottom:18px;">
          <div style="font-size:13px;font-weight:700;color:#fbbf24;margin-bottom:10px;">ğŸªª Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© (${repeatIds.length} Ø´Ø®Øµ)</div>
          ${repeatIds.length ? `
          <div style="overflow-x:auto;">
          <table class="report-table" style="min-width:600px;">
            <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø´Ø±ÙƒØ©</th><th style="text-align:center;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</th><th>Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</th></tr></thead>
            <tbody>
              ${repeatIds.slice(0,15).map(([id,arr])=>`
                <tr>
                  <td style="font-family:monospace;color:#fbbf24;">${id}</td>
                  <td>${[...new Set(arr.map(x=>x.companyName))].join('ØŒ ')}</td>
                  <td style="text-align:center;"><span class="repeat-count-badge">${arr.length}x</span></td>
                  <td style="font-size:11px;color:var(--muted);">${arr.map(x=>x.date).join(' | ')}</td>
                </tr>`).join('')}
            </tbody>
          </table>
          </div>` : '<div style="color:var(--muted);padding:12px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>'}
        </div>

        <!-- Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ù„ÙˆØ­Ø© -->
        <div style="margin-bottom:18px;border-top:1px solid var(--border);padding-top:16px;">
          <div style="font-size:13px;font-weight:700;color:#f87171;margin-bottom:10px;">ğŸš— Ù…ÙƒØ±Ø± Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© (${repeatPlates.length} Ù„ÙˆØ­Ø©)</div>
          ${repeatPlates.length ? `
          <div style="overflow-x:auto;">
          <table class="report-table" style="min-width:600px;">
            <thead><tr><th>Ø§Ù„Ù„ÙˆØ­Ø©</th><th>Ø§Ù„Ø´Ø±ÙƒØ©</th><th style="text-align:center;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</th><th>Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th></tr></thead>
            <tbody>
              ${repeatPlates.slice(0,15).map(([plate,arr])=>`
                <tr>
                  <td style="font-family:monospace;font-size:15px;font-weight:900;color:#f87171;letter-spacing:3px;">${plate}</td>
                  <td>${[...new Set(arr.map(x=>x.companyName))].join('ØŒ ')}</td>
                  <td style="text-align:center;"><span class="repeat-count-badge">${arr.length}x</span></td>
                  <td style="font-size:11px;color:var(--muted);">${arr.map(x=>x.date).join(' | ')}</td>
                  <td style="font-size:11px;color:var(--muted);">${arr.map(x=>x.mainViolationTypeLabel||x.subViolationType).join(' | ')}</td>
                </tr>`).join('')}
            </tbody>
          </table>
          </div>` : '<div style="color:var(--muted);padding:12px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>'}
        </div>



      </div>
    </div>
    <!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ù„ÙÙŠÙ† Ø§Ù„Ù…ØªÙƒØ±Ø±ÙŠÙ† -->

    <!-- ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª -->
    <div class="card" style="margin-bottom:20px;">
      <div class="card-header"><h3>ğŸ‘¥ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3></div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
          ${Object.entries(groupMap).map(([g,c])=>`
            <div style="background:var(--gold-dim);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;">
              <div style="font-size:11px;color:var(--gold);margin-bottom:6px;">${g}</div>
              <div style="font-size:26px;font-weight:900;color:#ffd700;">${c}</div>
            </div>`).join('')}
        </div>
      </div>
    </div>

    <!-- Ø£Ù†Ø´Ø· Ø§Ù„Ù…ÙØªØ´ÙŠÙ† -->
    <div class="charts-grid" style="margin-bottom:20px;">
      <div class="card">
        <div class="card-header"><h3>ğŸ† Ø£Ù†Ø´Ø· Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</h3></div>
        <div class="card-body">
          <ul class="top-list">
            ${topInsp.map(([name,count],i)=>`
              <li>
                <div class="top-rank">${i+1}</div>
                <span class="top-name">${name}</span>
                <span class="top-count">${count}</span>
              </li>`).join('')}
          </ul>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ‘® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ† Ø§Ù„ÙƒØ§Ù…Ù„Ø© (${allInspList.length})</h3></div>
        <div class="card-body" style="overflow-x:auto;max-height:320px;overflow-y:auto;">
          <table class="report-table" style="min-width:400px;">
            <thead><tr><th>#</th><th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</th></tr></thead>
            <tbody>
              ${allInspList.map(([id,u],i)=>{
                const count = violations.filter(v=>v.inspectorId===id).length;
                return `<tr>
                  <td>${i+1}</td>
                  <td style="font-family:monospace;color:var(--gold);">${id}</td>
                  <td>${u.name}</td>
                  <td style="text-align:center;"><span style="background:var(--gold-dim);padding:2px 10px;border-radius:20px;color:var(--gold-light);">${count}</span></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ø¢Ø®Ø± 20 Ù…Ø®Ø§Ù„ÙØ© -->
    <div class="card">
      <div class="card-header"><h3>ğŸ• Ø¢Ø®Ø± 20 Ù…Ø®Ø§Ù„ÙØ© Ù…Ø³Ø¬Ù„Ø©</h3></div>
      <div class="card-body" style="overflow-x:auto;">
        <table class="report-table" style="min-width:800px;">
          <thead>
            <tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ù…ÙØªØ´</th><th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…ÙƒØ±Ø±</th><th>PDF</th></tr>
          </thead>
          <tbody>
            ${recent.map(v=>{
              const stMap={pending:'â³',approved:'âœ…',rejected:'âŒ'};
              const r = getRepeatInfo(v);
              const hasRepeat = r.plate.length||r.id.length||r.company.length;
              const repeatCell = hasRepeat
                ? `<span class="repeat-count-badge">${(r.plate.length?'ğŸš—':'')+(r.id.length?'ğŸªª':'')+(r.company.length?'ğŸ¢':'')}</span>`
                : 'â€”';
              return `<tr style="${hasRepeat?'background:rgba(239,68,68,0.04);':''}">
                <td style="color:var(--gold);font-size:11px;">${v.refNumber}</td>
                <td>${v.mainViolationTypeLabel||'â€”'}</td>
                <td>${v.companyName||'â€”'}</td>
                <td>${v.inspector||'â€”'}</td>
                <td>${v.zone||'â€”'}</td>
                <td>${v.date} ${v.time}</td>
                <td>${stMap[v.status]||'â€”'}</td>
                <td>${repeatCell}</td>
                <td><button class="btn-sm btn-pdf" onclick="generatePDF(violations.find(x=>x.refNumber==='${v.refNumber}'))">ğŸ“„</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function exportAdminReport() {
  if (!violations.length) { showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª','error'); return; }
  const data = violations.map((v,i)=>({
    'Ù…':i+1,'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ':v.refNumber,
    'Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ':v.mainViolationTypeLabel,'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©':v.subViolationType,
    'Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­':v.permitType,'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©':v.zone,'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©':v.receivingGroup||'â€”',
    'Ø§Ù„Ø´ÙØª':v.shift,'Ø§Ù„ÙˆÙ‚Øª':v.violationTime,'Ø§Ù„Ø´Ø±ÙƒØ©':v.companyName,
    'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©':v.violatorId,'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„':v.violatorPhone,
    'Ø§Ù„Ù…ÙØªØ´':v.inspector,'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ':v.inspectorId,
    'Ø§Ù„ØªØ§Ø±ÙŠØ®':v.date,'Ø§Ù„Ø³Ø§Ø¹Ø©':v.time,
    'Ø§Ù„Ø­Ø§Ù„Ø©':v.status==='pending'?'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©':v.status==='approved'?'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§':'Ù…Ø±ÙÙˆØ¶Ø©',
    'Ø§Ù„Ù…Ø´Ø±Ù':v.reviewedBy||'â€”','Ù…Ù„Ø§Ø­Ø¸Ø§Øª':v.reviewNotes||'â€”'
  }));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„');
  XLSX.writeFile(wb,`ADMIN_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${violations.length} Ù…Ø®Ø§Ù„ÙØ© â€” Admin Report`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendToGoogleSheets(v){
  try {
    if (!GOOGLE_SCRIPT_URL) { console.warn('âš ï¸ GOOGLE_SCRIPT_URL ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·'); return; }
    const statusMap = { approved:'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§', rejected:'Ù…Ø±ÙÙˆØ¶Ø©', pending:'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' };
    const sheetData = {
      refNumber:        v.refNumber,
      mainViolationType: v.mainViolationTypeLabel || '-',
      subViolationType:  v.subViolationType || '-',
      personCount:       v.personCount || '-',
      permitType:        v.permitType || '-',
      zone:              v.zone || '-',
      receivingGroup:    v.receivingGroup || '-',
      shift:             v.shift || '-',
      violationTime:     v.violationTime || '-',
      companyName:       v.companyName || '-',
      violatorId:        v.violatorId || '-',
      violatorPhone:     v.violatorPhone || '-',
      vehiclePlate:      v.vehiclePlate || '-',
      locationLink:      v.location ? `https://www.google.com/maps?q=${v.location.lat},${v.location.lng}` : '-',
      inspector:         v.inspector || '-',
      inspectorId:       v.inspectorId || '-',
      date:              v.date || '-',
      time:              v.time || '-',
      status:            statusMap[v.status] || 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
      reviewedBy:        v.reviewedBy || '-',
      reviewerId:        v.reviewerId || '-',
      reviewDate:        v.reviewDate || '-',
      reviewTime:        v.reviewTime || '-',
      reviewNotes:       v.reviewNotes || '-'
    };

    // Method 1: Try fetch with redirect follow
    try {
      const resp = await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        redirect: 'follow',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(sheetData)
      });
      console.log('âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Google Sheets (fetch):', v.refNumber);
    } catch(fetchErr) {
      // Method 2: Fallback using form submission via hidden iframe
      console.warn('âš ï¸ fetch failed, trying form fallback...', fetchErr);
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = GOOGLE_SCRIPT_URL;
      form.target = 'gs_iframe';
      form.style.display = 'none';
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'data';
      input.value = JSON.stringify(sheetData);
      form.appendChild(input);
      // Create hidden iframe if not exists
      let iframe = document.getElementById('gs_iframe');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'gs_iframe';
        iframe.name = 'gs_iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
      }
      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 3000);
      console.log('âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Google Sheets (form fallback):', v.refNumber);
    }
  } catch(e) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Google Sheets:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadExcelFile(){
  let exportList = violations;
  if (currentUser && currentUser.role === 'supervisor' && currentUser.group) {
    exportList = exportList.filter(v => v.receivingGroup === currentUser.group);
  }
  if(!exportList.length){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ù„Ù„ØªØµØ¯ÙŠØ±','error');return;}
  const data=exportList.map((v,i)=>({
    'Ù…':i+1,'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ':v.refNumber,
    'Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ':v.mainViolationTypeLabel,'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©':v.subViolationType,
    'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ':v.personCount||'â€”','Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±ÙŠØ­':v.permitType,
    'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©':v.zone,'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©':v.receivingGroup||'â€”',
    'Ø§Ù„Ø´ÙØª':v.shift,'Ø§Ù„ÙˆÙ‚Øª':v.violationTime,
    'Ø§Ù„Ø´Ø±ÙƒØ©':v.companyName,'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©':v.violatorId,
    'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„':v.violatorPhone,'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©':v.vehiclePlate||'â€”',
    'Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹':v.location?`https://www.google.com/maps?q=${v.location.lat},${v.location.lng}`:'â€”',
    'Ø§Ù„Ù…ÙØªØ´':v.inspector,'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ':v.inspectorId,
    'Ø§Ù„ØªØ§Ø±ÙŠØ®':v.date,'Ø§Ù„Ø³Ø§Ø¹Ø©':v.time,
    'Ø§Ù„Ø­Ø§Ù„Ø©':v.status==='pending'?'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©':v.status==='approved'?'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§':'Ù…Ø±ÙÙˆØ¶Ø©',
    'Ø§Ù„Ù…Ø´Ø±Ù':v.reviewedBy||'â€”','Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø±Ù':v.reviewerId||'â€”',
    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©':v.reviewDate||'â€”','ÙˆÙ‚Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©':v.reviewTime||'â€”',
    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù':v.reviewNotes||'â€”'
  }));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª');
  XLSX.writeFile(wb,`Ù…Ø®Ø§Ù„ÙØ§Øª_Ø§Ù„Ù‚Ø¯ÙŠØ©_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${violations.length} Ù…Ø®Ø§Ù„ÙØ©!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme() {
  const isLight = document.body.classList.toggle('light-mode');
  const icon  = document.getElementById('themeIcon');
  const label = document.getElementById('themeLabel');
  if (isLight) {
    icon.textContent  = 'ğŸŒ™';
    label.textContent = 'Ù„ÙŠÙ„ÙŠ';
  } else {
    icon.textContent  = 'â˜€ï¸';
    label.textContent = 'Ù†Ù‡Ø§Ø±ÙŠ';
  }
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = () => {
  loadFromStorage();
  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-mode');
    document.getElementById('themeIcon').textContent  = 'ğŸŒ™';
    document.getElementById('themeLabel').textContent = 'Ù„ÙŠÙ„ÙŠ';
  }
};
document.addEventListener('keypress', e => {
  if (e.key === 'Enter' && document.getElementById('mainApp').classList.contains('hide')) login();
});
</script>
</body>
</html>